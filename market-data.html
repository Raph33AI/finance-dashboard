<!DOCTYPE html>
<html lang='fr'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <meta name='description' content='Market Data Dashboard - Real-time stock analysis, technical indicators, watchlist and price alerts'>
    <meta name='author' content='Raphael NARDONE'>
    <meta name='theme-color' content='#2563eb'>
    
    <title>Market Data - Finance Hub</title>
    
    <!-- Preconnect pour optimisation -->
    <link rel='preconnect' href='https://code.highcharts.com'>
    <link rel='preconnect' href='https://cdnjs.cloudflare.com'>
    
    <!-- Highcharts - ORDRE IMPORTANT -->
    <script src='https://code.highcharts.com/stock/highstock.js' defer></script>
    <script src='https://code.highcharts.com/stock/indicators/indicators-all.js' defer></script>
    <script src='https://code.highcharts.com/stock/modules/drag-panes.js' defer></script>
    <script src='https://code.highcharts.com/modules/annotations-advanced.js' defer></script>
    <script src='https://code.highcharts.com/modules/price-indicator.js' defer></script>
    <script src='https://code.highcharts.com/modules/full-screen.js' defer></script>
    <script src='https://code.highcharts.com/modules/stock-tools.js' defer></script>
    <script src='https://code.highcharts.com/modules/exporting.js' defer></script>
    <script src='https://code.highcharts.com/modules/export-data.js' defer></script>
    <script src='https://code.highcharts.com/modules/accessibility.js' defer></script>
    
    <!-- Font Awesome -->
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css' integrity='sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==' crossorigin='anonymous' referrerpolicy='no-referrer'>
    
    <!-- Styles -->
    <link rel='stylesheet' href='assets/css/common.css'>
    <link rel='stylesheet' href='assets/css/sidebar.css'>
    <link rel='stylesheet' href='assets/css/market-data.css'>
    <link rel='stylesheet' href='assets/css/user-menu.css'>
    <link rel='stylesheet' href='assets/css/cache-widget.css'>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Configuration Firebase -->
    <script src="assets/js/firebase-config.js"></script>
    
    <!-- Protection de la page (AUTH GUARD) -->
    <script src="assets/js/auth-guard.js"></script>
</head>
<body>

    <!-- âš¡ THEME SCRIPT - DOIT ÃŠTRE CHARGÃ‰ EN PREMIER -->
    <script src="assets/js/theme.js"></script>

    <!-- ðŸŽ¨ THEME CHARTS - POUR LES GRAPHIQUES -->
    <script src="assets/js/theme-charts.js"></script>

    <div class='layout-wrapper'>
        
        <!-- ============================================
             SIDEBAR NAVIGATION
             ============================================ -->
        <aside class='sidebar' id='sidebar'>
            <!-- Header -->
            <div class='sidebar-header'>
                <h2><i class='fas fa-chart-line'></i> Finance Hub</h2>
                <button class='sidebar-toggle' id='sidebarToggle'>
                    <i class='fas fa-bars'></i>
                </button>
            </div>
            
            <!-- Navigation -->
            <nav class='sidebar-nav'>
                <!-- Landing Page / Accueil -->
                <div class='nav-section'>
                    <a href='index.html' class='nav-link'>
                        <i class='fas fa-rocket'></i>
                        <span>Home</span>
                    </a>
                </div>
                
                <!-- Budget Section -->
                <div class='nav-section'>
                    <button class='nav-folder'>
                        <i class='fas fa-wallet'></i>
                        <span>Budget</span>
                        <i class='fas fa-chevron-down arrow'></i>
                    </button>
                    <div class='nav-submenu'>
                        <a href='dashboard-financier.html' class='nav-link'>
                            <i class='fas fa-home'></i>
                            <span>Dashboard Budget</span>
                        </a>
                        <a href='investment-analytics.html' class='nav-link'>
                            <i class='fas fa-chart-bar'></i>
                            <span>Investment Analytics</span>
                        </a>
                    </div>
                </div>
                
                <!-- Simulation Section -->
                <div class='nav-section'>
                    <button class='nav-folder'>
                        <i class='fas fa-calculator'></i>
                        <span>Simulation</span>
                        <i class='fas fa-chevron-down arrow'></i>
                    </button>
                    <div class='nav-submenu'>
                        <a href='monte-carlo.html' class='nav-link'>
                            <i class='fas fa-dice'></i>
                            <span>Monte Carlo</span>
                        </a>
                        <a href='portfolio-optimizer.html' class='nav-link'>
                            <i class='fas fa-chart-pie'></i>
                            <span>Markowitz</span>
                        </a>
                        <a href='risk-parity.html' class='nav-link'>
                            <i class='fas fa-balance-scale'></i>
                            <span>Risk Parity</span>
                        </a>
                        <a href='scenario-analysis.html' class='nav-link'>
                            <i class='fas fa-flask'></i>
                            <span>Scenarios</span>
                        </a>
                    </div>
                </div>
                
                <!-- Stocks Section -->
                <div class='nav-section'>
                    <button class='nav-folder active'>
                        <i class='fas fa-chart-candlestick'></i>
                        <span>Stocks</span>
                        <i class='fas fa-chevron-down arrow'></i>
                    </button>
                    <div class='nav-submenu' style='display: block;'>
                        <a href='market-data.html' class='nav-link active'>
                            <i class='fas fa-database'></i>
                            <span>Market Data</span>
                        </a>
                        <a href='advanced-analysis.html' class='nav-link'>
                            <i class='fas fa-brain'></i>
                            <span>Advanced Analysis</span>
                        </a>
                        <a href='trend-prediction.html' class='nav-link'>
                            <i class='fas fa-chart-line'></i>
                            <span>Trend Prediction</span>
                        </a>
                    </div>
                </div>
            </nav>
            
            <!-- ===== SIDEBAR FOOTER - MENU UTILISATEUR ===== -->
            <div class="sidebar-footer">
                <div class="sidebar-user-menu">
                    <!-- Trigger (Ã©lÃ©ment cliquable) -->
                    <div class="sidebar-user-trigger" id="sidebarUserTrigger">
                        <img data-user-photo 
                            src="https://ui-avatars.com/api/?name=User&background=2563eb&color=fff" 
                            alt="Avatar" 
                            class="sidebar-user-avatar">
                        <div class="sidebar-user-info">
                            <span data-user-name class="sidebar-user-name">User</span>
                            <span data-user-plan class="sidebar-user-plan">Free Plan</span>
                        </div>
                        <i class="fas fa-chevron-up sidebar-user-arrow"></i>
                    </div>
                    
                    <!-- Dropdown (s'ouvre vers le haut) -->
                    <div class="sidebar-user-dropdown" id="sidebarUserDropdown">
                        <div class="user-dropdown-header">
                            <img data-user-photo 
                                src="https://ui-avatars.com/api/?name=User&background=2563eb&color=fff" 
                                alt="Avatar" 
                                class="user-dropdown-avatar">
                            <div class="user-dropdown-details">
                                <h4 data-user-name class="user-dropdown-name">User</h4>
                                <p data-user-email class="user-dropdown-email">email@example.com</p>
                            </div>
                        </div>
                        
                        <div class="user-dropdown-divider"></div>
                        
                        <nav class="user-dropdown-links">
                            <a href="user-profile.html" class="user-dropdown-link">
                                <i class="fas fa-user"></i>
                                <span>My profile</span>
                            </a>
                            <a href="settings.html" class="user-dropdown-link">
                                <i class="fas fa-cog"></i>
                                <span>Settings</span>
                            </a>
                            <a href="#" class="user-dropdown-link">
                                <i class="fas fa-question-circle"></i>
                                <span>Help</span>
                            </a>
                        </nav>
                        
                        <div class="user-dropdown-divider"></div>
                        
                        <button onclick="logout()" class="user-dropdown-logout">
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Disconnect</span>
                        </button>
                    </div>
                </div>
            </div>
            <!-- ===== FIN SIDEBAR FOOTER ===== -->
        </aside>
        
        <!-- Sidebar Overlay (mobile) -->
        <div class='sidebar-overlay' id='sidebarOverlay' aria-hidden='true'></div>
        
        <!-- ============================================
             MAIN CONTENT AREA
             ============================================ -->
        <main class='main-content' role='main'>
            <!-- Top Header -->
            <header class='top-header'>
                <div class="header-content-wrapper">
                    <div class='header-left'>
                        <button class='mobile-toggle' id='mobileToggle' aria-label='Toggle navigation menu' aria-expanded='false'>
                            <i class='fas fa-bars' aria-hidden='true'></i>
                        </button>
                        <h1>Market Data</h1>
                    </div>
                    <div class='header-right'>
                        <span class='last-update' aria-live='polite'>
                            <i class='fas fa-clock' aria-hidden='true'></i>
                            <span id='lastUpdate'>Loading...</span>
                        </span>
                        <!-- âœ… NOUVEAU : Bouton de contrÃ´le du cache -->
                        <button class='btn-icon-header' onclick='toggleCacheWidget()' aria-label='Toggle cache widget' title='View cache statistics'>
                            <i class='fas fa-database' aria-hidden='true'></i>
                            <span class='cache-badge-mini' id='cacheBadgeMini'>0</span>
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Container -->
            <div class='container'>
                <!-- Main Content -->
                <div class='content'>
                    
                    <!-- ============================================
                         ðŸ“ PORTFOLIO MANAGEMENT SECTION (MODIFIÃ‰)
                         ============================================ -->
                    <section class='card portfolio-management-section' aria-labelledby='portfolio-title'>
                        <div class='card-header'>
                            <h2 class='card-title' id='portfolio-title'>
                                <i class='fas fa-briefcase' aria-hidden='true'></i> Portfolio Management
                            </h2>
                        </div>
                        
                        <div class='card-body'>
                            <div class='toolbar simulation-management'>
                                <div class='current-simulation-display'>
                                    <span class='label'>
                                        <i class='fas fa-folder-open'></i> Current portfolio:
                                    </span>
                                    <span class='value' id='currentPortfolioName'>default</span>
                                </div>
                                
                                <!-- âœ… MODIFIÃ‰ : Ajout des boutons de gestion du cache -->
                                <div class='toolbar-row' style='justify-content: center; gap: 10px; flex-wrap: wrap; margin-top: 15px;'>
                                    <!-- Boutons Portfolio -->
                                    <button class='btn btn-success' onclick='PortfolioManager.createNewPortfolio()'>
                                        <i class='fas fa-plus-circle'></i> New Portfolio
                                    </button>
                                    <button class='btn btn-primary' onclick='MarketData.saveCurrentPortfolio()'>
                                        <i class='fas fa-cloud-upload-alt'></i> Save Current
                                    </button>
                                    <button class='btn btn-secondary' onclick='openPortfoliosModal()'>
                                        <i class='fas fa-list'></i> Manage Portfolios
                                    </button>
                                    <button class='btn btn-secondary' onclick='MarketData.exportPortfolioJSON()'>
                                        <i class='fas fa-file-export'></i> Export JSON
                                    </button>
                                    <button class='btn btn-secondary' onclick='MarketData.importPortfolioJSON()'>
                                        <i class='fas fa-file-import'></i> Import JSON
                                    </button>
                                    
                                    <!-- âœ… NOUVEAU : SÃ©parateur visuel -->
                                    <div style='width: 100%; height: 1px; background: rgba(255,255,255,0.2); margin: 5px 0;'></div>
                                    
                                    <!-- âœ… NOUVEAU : Boutons de gestion du cache -->
                                    <button class='btn btn-warning' onclick='clearLocalCache()' title='Clear local cache (keeps cloud data)'>
                                        <i class='fas fa-broom'></i> Clear Local Cache
                                    </button>
                                    <button class='btn btn-info' onclick='viewCacheStats()' title='View detailed cache statistics'>
                                        <i class='fas fa-chart-pie'></i> Cache Stats
                                    </button>
                                </div>
                            </div>
                            
                            <div class='info-box info-box-white-text' style='margin-top: 1rem; margin-bottom: 0;'>
                                <h4><i class='fas fa-info-circle'></i> How it works</h4>
                                <p>Create multiple portfolios to organize your watchlists, alerts, and stock comparisons. All portfolios are automatically saved to the cloud and accessible from any device.</p>
                                <p style='margin-top: 0.5rem; margin-bottom: 0; font-size: 0.9em; opacity: 0.9;'>
                                    <i class='fas fa-database'></i> <strong>Cache System:</strong> Data is cached locally to reduce API calls. Rate limit: 8 requests/minute.
                                </p>
                            </div>
                        </div>
                    </section>

                    <!-- ============================================
                         ðŸ” SEARCH PANEL
                         ============================================ -->
                    <section class='search-panel card' aria-labelledby='search-title'>
                        <div class='card-header'>
                            <h2 class='card-title' id='search-title'>
                                <i class='fas fa-search' aria-hidden='true'></i> Search Stock for Market Data
                            </h2>
                            <button class='help-icon' onclick='openModal("modalSearchHelp")' aria-label='Help about searching stocks'>?</button>
                        </div>
                        
                        <div class='card-body'>
                            <div class='search-container'>
                                <!-- Search Input + Button -->
                                <div class='search-input-wrapper'>
                                    <label for='symbolInput' class='sr-only'>Stock symbol or company name</label>
                                    <input type='text' 
                                        id='symbolInput' 
                                        class='form-input'
                                        placeholder='Search by symbol or company name (e.g., AAPL, Apple, Tesla)...'
                                        autocomplete='off'
                                        value='AAPL'
                                        aria-describedby='search-instructions'>
                                    <button class='btn btn-primary btn-search' onclick='MarketData.searchStock()' aria-label='Analyze selected stock'>
                                        <i class='fas fa-chart-area' aria-hidden='true'></i> Analyze Stock
                                    </button>
                                    
                                    <!-- Suggestions dropdown -->
                                    <div class='search-suggestions' id='searchSuggestions' role='listbox' aria-label='Search suggestions'></div>
                                </div>
                                
                                <span id='search-instructions' class='sr-only'>Type to search for stocks. Use arrow keys to navigate suggestions, Enter to select.</span>
                                
                                <!-- Popular Stocks -->
                                <div class='popular-stocks'>
                                    <span class='quick-label'>Popular Stocks:</span>
                                    <button class='symbol-chip' onclick='MarketData.loadSymbol("AAPL")' aria-label='Load Apple stock'>
                                        <i class='fab fa-apple' aria-hidden='true'></i> AAPL
                                    </button>
                                    <button class='symbol-chip' onclick='MarketData.loadSymbol("MSFT")' aria-label='Load Microsoft stock'>
                                        <i class='fab fa-microsoft' aria-hidden='true'></i> MSFT
                                    </button>
                                    <button class='symbol-chip' onclick='MarketData.loadSymbol("GOOGL")' aria-label='Load Google stock'>
                                        <i class='fab fa-google' aria-hidden='true'></i> GOOGL
                                    </button>
                                    <button class='symbol-chip' onclick='MarketData.loadSymbol("TSLA")' aria-label='Load Tesla stock'>
                                        <i class='fas fa-car' aria-hidden='true'></i> TSLA
                                    </button>
                                    <button class='symbol-chip' onclick='MarketData.loadSymbol("BTC-USD")' aria-label='Load Bitcoin price'>
                                        <i class='fab fa-bitcoin' aria-hidden='true'></i> BTC-USD
                                    </button>
                                    <button class='symbol-chip' onclick='MarketData.loadSymbol("^GSPC")' aria-label='Load S&P 500 index'>
                                        <i class='fas fa-chart-line' aria-hidden='true'></i> S&P 500
                                    </button>
                                </div>
                                
                                <!-- Period Selection -->
                                <div class='time-period-selector' role='group' aria-labelledby='period-label'>
                                    <label id='period-label'>Time Period:</label>
                                    <button class='period-btn active' data-period='1M' onclick='MarketData.changePeriod("1M")' aria-pressed='true'>1M</button>
                                    <button class='period-btn' data-period='3M' onclick='MarketData.changePeriod("3M")' aria-pressed='false'>3M</button>
                                    <button class='period-btn' data-period='6M' onclick='MarketData.changePeriod("6M")' aria-pressed='false'>6M</button>
                                    <button class='period-btn' data-period='1Y' onclick='MarketData.changePeriod("1Y")' aria-pressed='false'>1Y</button>
                                    <button class='period-btn' data-period='5Y' onclick='MarketData.changePeriod("5Y")' aria-pressed='false'>5Y</button>
                                    <button class='period-btn' data-period='MAX' onclick='MarketData.changePeriod("MAX")' aria-pressed='false'>MAX</button>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- ============================================
                         ðŸ“Š STOCK COMPARISON SECTION
                         ============================================ -->
                    <section class='comparison-section card' aria-labelledby='comparison-title'>
                        <div class='card-header comparison-header'>
                            <h2 class='card-title' id='comparison-title'>
                                <i class='fas fa-chart-bar' aria-hidden='true'></i> Stock Comparison
                            </h2>
                            <div class='comparison-actions'>
                                <button class='btn btn-primary btn-compare' onclick='MarketData.openComparisonModal()'>
                                    <i class='fas fa-plus' aria-hidden='true'></i> Add Stocks to Compare
                                </button>
                                <button class='btn btn-danger btn-clear-comparison' onclick='MarketData.clearComparison()'>
                                    <i class='fas fa-trash' aria-hidden='true'></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class='card-body'>
                            <div id='comparisonContainer' class='comparison-container hidden'>
                                <!-- Selected stocks chips -->
                                <div class='comparison-stocks' id='comparisonStocks' role='list' aria-label='Stocks being compared'></div>
                                
                                <!-- Comparison Chart -->
                                <div class='comparison-chart-wrapper'>
                                    <h3 class='subsection-title'>Performance Comparison (Normalized to 100)</h3>
                                    <div id='comparisonChart' class='chart' role='img' aria-label='Stock performance comparison chart'></div>
                                </div>
                                
                                <!-- Comparison Table -->
                                <div class='comparison-table-wrapper'>
                                    <h3 class='subsection-title'>Key Metrics Comparison</h3>
                                    <div id='comparisonTable' class='comparison-table' role='region' aria-label='Comparison metrics table'></div>
                                </div>
                            </div>
                            
                            <div id='comparisonEmpty' class='comparison-empty'>
                                <i class='fas fa-chart-line' aria-hidden='true'></i>
                                <p>No stocks to compare</p>
                                <p class='hint'>Click "Add Stocks to Compare" to get started</p>
                            </div>
                        </div>
                    </section>
                    
                    <!-- ============================================
                         â­ WATCHLIST SECTION
                         ============================================ -->
                    <section class='watchlist-section card' aria-labelledby='watchlist-title'>
                        <div class='card-header watchlist-header'>
                            <h2 class='card-title' id='watchlist-title'>
                                <i class='fas fa-star' aria-hidden='true'></i> My Watchlist
                            </h2>
                            <div class='watchlist-actions'>
                                <button class='btn btn-success btn-add-current' onclick='MarketData.addCurrentToWatchlist()' id='btnAddCurrent' disabled>
                                    <i class='fas fa-plus' aria-hidden='true'></i> Add Current Stock
                                </button>
                                <button class='btn btn-primary btn-refresh-watchlist' onclick='MarketData.refreshWatchlist()'>
                                    <i class='fas fa-sync-alt' aria-hidden='true'></i> Refresh All
                                </button>
                                <button class='btn btn-danger btn-clear-watchlist' onclick='MarketData.clearWatchlist()'>
                                    <i class='fas fa-trash' aria-hidden='true'></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <div class='card-body'>
                            <div id='watchlistContainer' class='watchlist-container' role='list' aria-label='Watchlist stocks'>
                                <div class='watchlist-empty'>
                                    <i class='fas fa-star-half-alt' aria-hidden='true'></i>
                                    <p>Your watchlist is empty</p>
                                    <p class='hint'>Search for a stock and click "Add to Watchlist" to start tracking</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- ============================================
                         ðŸ”” PRICE ALERTS SECTION
                         ============================================ -->
                    <section class='alerts-section card' aria-labelledby='alerts-title'>
                        <div class='card-header alerts-header'>
                            <h2 class='card-title' id='alerts-title'>
                                <i class='fas fa-bell' aria-hidden='true'></i> Price Alerts
                            </h2>
                            <button class='btn btn-accent btn-create-alert' onclick='MarketData.openAlertModal()'>
                                <i class='fas fa-plus' aria-hidden='true'></i> Create Alert
                            </button>
                        </div>
                        
                        <div class='card-body'>
                            <div id='alertsContainer' class='alerts-container' role='list' aria-label='Active price alerts'>
                                <div class='alerts-empty'>
                                    <i class='fas fa-bell-slash' aria-hidden='true'></i>
                                    <p>No active alerts</p>
                                    <p class='hint'>Create price alerts to get notified when a stock reaches your target</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- ============================================
                         ðŸ“Š LOADING INDICATOR
                         ============================================ -->
                    <div id='loadingIndicator' class='loading-indicator hidden' role='status' aria-live='polite'>
                        <i class='fas fa-spinner fa-spin' aria-hidden='true'></i> Loading market data...
                    </div>
                    
                    <!-- ============================================
                         ðŸ“ˆ STOCK OVERVIEW
                         ============================================ -->
                    <section id='stockOverview' class='stock-overview hidden' aria-labelledby='stock-overview-title'>
                        <div class='overview-header'>
                            <div class='stock-title'>
                                <h2 id='stockName'>-</h2>
                                <span id='stockSymbol' class='stock-symbol'>-</span>
                            </div>
                            <div class='stock-price-section'>
                                <div id='currentPrice' class='current-price' aria-label='Current stock price'>-</div>
                                <div id='priceChange' class='price-change' aria-label='Price change'>-</div>
                            </div>
                        </div>
                        
                        <div class='overview-stats' role='list' aria-label='Stock statistics'>
                            <div class='stat-item' role='listitem'>
                                <span class='stat-label'>Open</span>
                                <span id='statOpen' class='stat-value'>-</span>
                            </div>
                            <div class='stat-item' role='listitem'>
                                <span class='stat-label'>High</span>
                                <span id='statHigh' class='stat-value'>-</span>
                            </div>
                            <div class='stat-item' role='listitem'>
                                <span class='stat-label'>Low</span>
                                <span id='statLow' class='stat-value'>-</span>
                            </div>
                            <div class='stat-item' role='listitem'>
                                <span class='stat-label'>Volume</span>
                                <span id='statVolume' class='stat-value'>-</span>
                            </div>
                            <div class='stat-item' role='listitem'>
                                <span class='stat-label'>Mkt Cap</span>
                                <span id='statMarketCap' class='stat-value'>-</span>
                            </div>
                            <div class='stat-item' role='listitem'>
                                <span class='stat-label'>P/E Ratio</span>
                                <span id='statPE' class='stat-value'>-</span>
                            </div>
                        </div>
                    </section>

                    <!-- ============================================
                         ðŸ¢ COMPANY PROFILE & STATISTICS (AccordÃ©on)
                         ============================================ -->
                    <section id='companyProfileSection' class='company-profile-section card hidden' aria-labelledby='company-profile-title'>
                        <!-- Le contenu sera gÃ©nÃ©rÃ© dynamiquement par JavaScript avec des accordÃ©ons -->
                    </section>
                    
                    <!-- ============================================
                         ðŸ“Š RESULTS PANEL
                         ============================================ -->
                    <section id='resultsPanel' class='results-panel card hidden' aria-labelledby='results-title'>
                        <div class='card-body'>
                            
                            <!-- Price Chart -->
                            <div class='chart-section'>
                                <h3 class='subsection-title' id='price-chart-title'>
                                    <i class='fas fa-chart-line' aria-hidden='true'></i> Price Chart with Technical Indicators
                                    <!-- âœ… CORRIGÃ‰ : Bouton help commentÃ© (modal n'existe pas) -->
                                    <!-- <button class='help-icon' onclick='openModal("modalChartHelp")' aria-label='Help about price chart'>?</button> -->
                                </h3>
                                <div class='indicator-toggles' role='group' aria-label='Technical indicator toggles'>
                                    <label><input type='checkbox' id='toggleSMA' checked> SMA (20, 50)</label>
                                    <label><input type='checkbox' id='toggleEMA'> EMA (12, 26)</label>
                                    <label><input type='checkbox' id='toggleBB' checked> Bollinger Bands</label>
                                    <label><input type='checkbox' id='toggleVolume' checked> Volume</label>
                                </div>
                                <div id='priceChart' class='chart' role='img' aria-labelledby='price-chart-title'></div>
                            </div>
                            
                            <!-- Technical Indicators -->
                            <div class='charts-grid-2'>
                                <div class='chart-section'>
                                    <h3 class='subsection-title' id='rsi-title'>
                                        <i class='fas fa-wave-square' aria-hidden='true'></i> RSI (Relative Strength Index)
                                        <!-- âœ… CORRIGÃ‰ : Bouton help commentÃ© (modal n'existe pas) -->
                                        <!-- <button class='help-icon' onclick='openModal("modalRSI")' aria-label='Help about RSI'>?</button> -->
                                    </h3>
                                    <div id='rsiChart' class='chart chart-medium' role='img' aria-labelledby='rsi-title'></div>
                                </div>
                                
                                <div class='chart-section'>
                                    <h3 class='subsection-title' id='macd-title'>
                                        <i class='fas fa-chart-bar' aria-hidden='true'></i> MACD (Moving Average Convergence Divergence)
                                        <!-- âœ… CORRIGÃ‰ : Bouton help commentÃ© (modal n'existe pas) -->
                                        <!-- <button class='help-icon' onclick='openModal("modalMACD")' aria-label='Help about MACD'>?</button> -->
                                    </h3>
                                    <div id='macdChart' class='chart chart-medium' role='img' aria-labelledby='macd-title'></div>
                                </div>
                            </div>
                            
                            <!-- Trading Signals -->
                            <div class='signals-section'>
                                <h3 class='subsection-title' id='signals-title'>
                                    <i class='fas fa-signal' aria-hidden='true'></i> Trading Signals
                                    <!-- âœ… CORRIGÃ‰ : Bouton help commentÃ© (modal n'existe pas) -->
                                    <!-- <button class='help-icon' onclick='openModal("modalSignals")' aria-label='Help about trading signals'>?</button> -->
                                </h3>
                                <div id='tradingSignals' class='signals-grid' role='list' aria-labelledby='signals-title'></div>
                            </div>
                            
                            <!-- Key Statistics -->
                            <div class='stats-section'>
                                <h3 class='subsection-title'><i class='fas fa-table' aria-hidden='true'></i> Key Statistics</h3>
                                <div id='keyStats' class='stats-grid' role='list' aria-label='Key stock statistics'></div>
                            </div>
                            
                        </div>
                    </section>
                </div>
                
                <!-- Footer -->
                <footer role='contentinfo'>
                    <p>&copy; 2024 Market Data Dashboard | Real-time financial data and technical analysis</p>
                    <p class='data-source'>Data provided by Twelve Data | Rate Limit: 8 requests/minute</p>
                </footer>
            </div>
        </main>
        
    </div>
    
    <!-- ============================================
         MODALS
         ============================================ -->
         
    <!-- ðŸ“ PORTFOLIOS MODAL -->
    <div class='modal' id='portfoliosModal' role='dialog' aria-labelledby='portfolios-modal-title' aria-modal='true'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h2 id='portfolios-modal-title'>
                    <i class='fas fa-briefcase'></i> Manage Portfolios
                </h2>
                <button class='close-modal' onclick='closePortfoliosModal()' aria-label='Close dialog'>
                    <i class='fas fa-times'></i>
                </button>
            </div>
            
            <div class='modal-body'>
                <div class='simulations-info'>
                    <p>
                        <i class='fas fa-info-circle'></i> 
                        <strong>Your portfolios are stored in the cloud.</strong>
                        Create multiple portfolios with different watchlists, alerts, and comparisons. Access them from any device!
                    </p>
                </div>
                
                <div id='portfoliosListContainer'>
                    <div class='loading-simulations'>
                        <i class='fas fa-spinner fa-spin'></i> Loading portfolios...
                    </div>
                </div>
            </div>
            
            <div class='modal-footer'>
                <button class='btn btn-primary' onclick='PortfolioManager.createNewPortfolio()'>
                    <i class='fas fa-plus'></i> New Portfolio
                </button>
                <button class='btn btn-secondary' onclick='closePortfoliosModal()'>
                    <i class='fas fa-times'></i> Close
                </button>
            </div>
        </div>
    </div>
    
    <!-- ðŸ“Š ADD COMPARISON MODAL -->
    <div id='modalAddComparison' class='modal' role='dialog' aria-labelledby='comparison-modal-title' aria-modal='true'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h2 id='comparison-modal-title'>
                    <i class='fas fa-chart-bar'></i> Add Stocks to Compare
                </h2>
                <button class='close-modal' onclick='MarketData.closeComparisonModal()' aria-label='Close dialog'>
                    <i class='fas fa-times'></i>
                </button>
            </div>
            <div class='modal-body'>
                <form class='comparison-form' onsubmit='event.preventDefault(); MarketData.loadComparison();'>
                    <div class='form-group'>
                        <label for='comparisonSymbols'>Enter stock symbols (comma-separated):</label>
                        <input type='text' id='comparisonSymbols' class='form-input' placeholder='e.g., AAPL, MSFT, GOOGL, TSLA' required>
                        <small>You can compare up to 5 stocks at once</small>
                    </div>
                    
                    <div class='comparison-quick-presets'>
                        <label>Quick Presets:</label>
                        <button type='button' class='preset-btn' onclick='document.getElementById("comparisonSymbols").value="AAPL,MSFT,GOOGL,META,AMZN"'>
                            <i class='fas fa-laptop-code'></i> Big Tech (FAANG)
                        </button>
                        <button type='button' class='preset-btn' onclick='document.getElementById("comparisonSymbols").value="BTC-USD,ETH-USD,BNB-USD,ADA-USD"'>
                            <i class='fab fa-bitcoin'></i> Top Cryptocurrencies
                        </button>
                        <button type='button' class='preset-btn' onclick='document.getElementById("comparisonSymbols").value="^GSPC,^DJI,^IXIC,^FTSE"'>
                            <i class='fas fa-chart-line'></i> Major Indices
                        </button>
                    </div>
                    
                    <div class='form-actions'>
                        <button type='submit' class='btn btn-create'>
                            <i class='fas fa-chart-bar'></i> Load Comparison
                        </button>
                        <button type='button' class='btn btn-cancel' onclick='MarketData.closeComparisonModal()'>
                            <i class='fas fa-times'></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- ðŸ”” CREATE ALERT MODAL -->
    <div id='modalCreateAlert' class='modal' role='dialog' aria-labelledby='alert-modal-title' aria-modal='true'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h2 id='alert-modal-title'>
                    <i class='fas fa-bell'></i> Create Price Alert
                </h2>
                <button class='close-modal' onclick='MarketData.closeAlertModal()' aria-label='Close dialog'>
                    <i class='fas fa-times'></i>
                </button>
            </div>
            <div class='modal-body'>
                <form class='alert-form' onsubmit='event.preventDefault(); MarketData.createAlert();'>
                    <div class='form-group'>
                        <label for='alertSymbol'>Stock Symbol:</label>
                        <input type='text' id='alertSymbol' class='form-input' placeholder='e.g., AAPL' required>
                    </div>
                    
                    <div class='form-group'>
                        <label for='alertPrice'>Target Price (USD):</label>
                        <input type='number' id='alertPrice' class='form-input' placeholder='e.g., 150.00' step='0.01' min='0' required>
                    </div>
                    
                    <div class='form-group'>
                        <label for='alertType'>Alert Type:</label>
                        <select id='alertType' class='form-input'>
                            <option value='above'>Alert when price goes ABOVE target</option>
                            <option value='below'>Alert when price goes BELOW target</option>
                        </select>
                    </div>
                    
                    <div class='form-group'>
                        <label for='alertNote'>Note (optional):</label>
                        <textarea id='alertNote' class='form-input' rows='3' placeholder='Add a personal note for this alert...'></textarea>
                    </div>
                    
                    <div class='form-actions'>
                        <button type='submit' class='btn btn-create'>
                            <i class='fas fa-bell'></i> Create Alert
                        </button>
                        <button type='button' class='btn btn-cancel' onclick='MarketData.closeAlertModal()'>
                            <i class='fas fa-times'></i> Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- â“ SEARCH HELP MODAL -->
    <div id='modalSearchHelp' class='modal' role='dialog' aria-labelledby='search-help-title' aria-modal='true'>
        <div class='modal-content'>
            <div class='modal-header'>
                <h2 id='search-help-title'>
                    <i class='fas fa-question-circle'></i> How to Search Stocks
                </h2>
                <button class='close-modal' onclick='closeModal("modalSearchHelp")' aria-label='Close dialog'>
                    <i class='fas fa-times'></i>
                </button>
            </div>
            <div class='modal-body'>
                <h3>ðŸ“Š Symbol Format</h3>
                <p>Enter the <strong>stock ticker symbol</strong> to retrieve market data:</p>
                <ul>
                    <li><strong>US Stocks:</strong> AAPL, MSFT, GOOGL, TSLA</li>
                    <li><strong>Indices:</strong> ^GSPC (S&P 500), ^DJI (Dow Jones), ^IXIC (NASDAQ)</li>
                    <li><strong>Crypto:</strong> BTC-USD, ETH-USD</li>
                    <li><strong>European Stocks:</strong> AIR.PA (Airbus), MC.PA (LVMH)</li>
                </ul>
                
                <h3>ðŸ“ˆ Available Data</h3>
                <ul>
                    <li>Real-time price and change</li>
                    <li>Historical price charts</li>
                    <li>Technical indicators (RSI, MACD, Bollinger Bands)</li>
                    <li>Trading volume</li>
                    <li>Key statistics (P/E ratio, market cap, etc.)</li>
                </ul>
                
                <div class='info-box'>
                    ðŸ’¡ <strong>Pro Tip:</strong> Use the time period buttons to analyze different timeframes and spot trends!
                </div>
            </div>
        </div>
    </div>

<!-- ============================================
         ðŸ—„ï¸ CACHE MONITORING WIDGET (NOUVEAU & COMPLET)
         ============================================ -->
    <div id='cacheWidget' class='cache-widget'>
        <div class='cache-widget-header'>
            <h3><i class='fas fa-database'></i> Cache & Rate Limit Monitor</h3>
            <button class='cache-close-btn' onclick='toggleCacheWidget()' aria-label='Close cache widget'>
                <i class='fas fa-times'></i>
            </button>
        </div>
        
        <div class='cache-widget-body'>
            <!-- Rate Limit Section -->
            <div class='cache-section'>
                <h4><i class='fas fa-tachometer-alt'></i> API Rate Limit</h4>
                <div class='cache-stat-row'>
                    <span class='cache-stat-label'>Remaining Requests:</span>
                    <span class='cache-stat-value' id='rateLimitRemaining'>8</span>
                    <span class='cache-stat-unit'>/ 8 per minute</span>
                </div>
                <div class='cache-progress-bar'>
                    <div class='cache-progress-fill' id='rateLimitProgress' style='width: 100%;'></div>
                </div>
                <div class='cache-stat-row'>
                    <span class='cache-stat-label'>Queue Length:</span>
                    <span class='cache-stat-value' id='queueLength'>0</span>
                    <span class='cache-stat-unit'>pending requests</span>
                </div>
            </div>
            
            <!-- Cache Statistics -->
            <div class='cache-section'>
                <h4><i class='fas fa-hdd'></i> Local Cache Statistics</h4>
                <div class='cache-stat-row'>
                    <span class='cache-stat-label'>Cached Entries:</span>
                    <span class='cache-stat-value' id='cacheEntriesCount'>0</span>
                </div>
                <div class='cache-stat-row'>
                    <span class='cache-stat-label'>Cache Size:</span>
                    <span class='cache-stat-value' id='cacheSize'>0 KB</span>
                </div>
                <div class='cache-stat-row'>
                    <span class='cache-stat-label'>Hit Rate:</span>
                    <span class='cache-stat-value' id='cacheHitRate'>N/A</span>
                </div>
            </div>
            
            <!-- Actions -->
            <div class='cache-section'>
                <h4><i class='fas fa-wrench'></i> Actions</h4>
                <div class='cache-actions'>
                    <button class='btn-cache btn-cache-refresh' onclick='refreshCacheStats()'>
                        <i class='fas fa-sync-alt'></i> Refresh Stats
                    </button>
                    <button class='btn-cache btn-cache-clear' onclick='clearLocalCache()'>
                        <i class='fas fa-broom'></i> Clear Cache
                    </button>
                    <button class='btn-cache btn-cache-export' onclick='exportCacheData()'>
                        <i class='fas fa-download'></i> Export Data
                    </button>
                </div>
            </div>
            
            <!-- Recent Activity -->
            <div class='cache-section'>
                <h4><i class='fas fa-history'></i> Recent API Calls</h4>
                <div class='cache-activity' id='cacheActivity'>
                    <p class='cache-empty-state'>No recent activity</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Bouton toggle cache (quand widget fermÃ©) -->
    <button class='cache-toggle-btn' onclick='toggleCacheWidget()' aria-label='Toggle cache statistics panel' style='display: none;'>
        <i class='fas fa-database' aria-hidden='true'></i>
        <span class='cache-badge' id='cacheBadge' aria-label='Number of cached entries'>0</span>
    </button>
    
    <!-- ============================================
         INLINE STYLES FOR CORRECTIONS
         ============================================ -->
    <style>
        /* Screen reader only class */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
        
        /* Texte blanc forcÃ© dans info-box */
        .info-box-white-text,
        .info-box-white-text h4,
        .info-box-white-text p,
        .info-box-white-text h4 i {
            color: white !important;
        }
        
        /* Texte blanc dans simulation-management */
        .simulation-management,
        .simulation-management .label,
        .simulation-management .value,
        .simulation-management i {
            color: white !important;
        }
        
        [data-theme="dark"] .simulation-management .label,
        [data-theme="dark"] .simulation-management .value,
        [data-theme="dark"] .simulation-management i {
            color: white !important;
        }
        
        /* Badge cache mini dans header */
        .cache-badge-mini {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            font-size: 0.625rem;
            font-weight: 600;
            padding: 2px 5px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }
        
        .btn-icon-header {
            position: relative;
            background: var(--background-secondary);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-base);
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-icon-header:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }
        
        /* Boutons warning et info dans toolbar */
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white !important;
            border: none;
        }
        
        .btn-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            color: white !important;
            border: none;
        }
        
        .btn-info:hover {
            background: linear-gradient(135deg, #0891b2 0%, #0e7490 100%);
        }
    </style>

    <!-- ============================================
         ðŸ“œ SCRIPTS - ORDRE IMPORTANT
         ============================================ -->
    
    <!-- âœ… Cache Widget Script -->
    <script>
        /**
         * ðŸ—„ï¸ Cache Widget Management
         */
        let cacheWidgetOpen = false;
        let cacheStats = {
            hits: 0,
            misses: 0,
            entries: 0,
            size: 0
        };
        
        /**
         * Toggle cache widget
         */
        function toggleCacheWidget() {
            const widget = document.getElementById('cacheWidget');
            if (!widget) return;
            
            cacheWidgetOpen = !cacheWidgetOpen;
            
            if (cacheWidgetOpen) {
                widget.classList.add('active');
                refreshCacheStats();
            } else {
                widget.classList.remove('active');
            }
        }
        
        /**
         * Refresh cache statistics
         */
        function refreshCacheStats() {
            console.log('ðŸ”„ Refreshing cache stats...');
            
            // Compter les entrÃ©es en cache
            let entries = 0;
            let totalSize = 0;
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('md_cache_')) {
                    entries++;
                    const value = localStorage.getItem(key);
                    if (value) {
                        totalSize += value.length;
                    }
                }
            }
            
            cacheStats.entries = entries;
            cacheStats.size = totalSize;
            
            // Mettre Ã  jour l'affichage
            const entriesEl = document.getElementById('cacheEntriesCount');
            const sizeEl = document.getElementById('cacheSize');
            const hitRateEl = document.getElementById('cacheHitRate');
            const badgeEl = document.getElementById('cacheBadge');
            const badgeMiniEl = document.getElementById('cacheBadgeMini');
            
            if (entriesEl) entriesEl.textContent = entries;
            if (sizeEl) sizeEl.textContent = (totalSize / 1024).toFixed(2) + ' KB';
            if (badgeEl) badgeEl.textContent = entries;
            if (badgeMiniEl) badgeMiniEl.textContent = entries;
            
            // Calculer le hit rate
            const total = cacheStats.hits + cacheStats.misses;
            if (total > 0 && hitRateEl) {
                const hitRate = (cacheStats.hits / total * 100).toFixed(1);
                hitRateEl.textContent = hitRate + '%';
            }
            
            console.log('âœ… Cache stats refreshed:', cacheStats);
        }
        
        /**
         * Clear local cache
         */
        function clearLocalCache() {
            if (!confirm('Are you sure you want to clear the local cache? This will remove all cached stock data.')) {
                return;
            }
            
            console.log('ðŸ—‘ï¸ Clearing local cache...');
            
            let cleared = 0;
            const keys = [];
            
            // Collecter les clÃ©s Ã  supprimer
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('md_cache_')) {
                    keys.push(key);
                }
            }
            
            // Supprimer les entrÃ©es
            keys.forEach(key => {
                localStorage.removeItem(key);
                cleared++;
            });
            
            // RÃ©initialiser les stats
            cacheStats.hits = 0;
            cacheStats.misses = 0;
            
            console.log(`âœ… Cleared ${cleared} cache entries`);
            
            refreshCacheStats();
            
            if (window.MarketData && window.MarketData.showNotification) {
                window.MarketData.showNotification(`Cache cleared: ${cleared} entries removed`, 'success');
            } else {
                alert(`Cache cleared: ${cleared} entries removed`);
            }
        }
        
        /**
         * View detailed cache statistics
         */
        function viewCacheStats() {
            refreshCacheStats();
            toggleCacheWidget();
        }
        
        /**
         * Export cache data
         */
        function exportCacheData() {
            console.log('ðŸ“¤ Exporting cache data...');
            
            const cacheData = {};
            
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('md_cache_')) {
                    try {
                        const value = localStorage.getItem(key);
                        cacheData[key] = JSON.parse(value);
                    } catch (e) {
                        cacheData[key] = localStorage.getItem(key);
                    }
                }
            }
            
            const exportObj = {
                exportDate: new Date().toISOString(),
                stats: cacheStats,
                data: cacheData
            };
            
            const json = JSON.stringify(exportObj, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cache_export_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            console.log('âœ… Cache data exported');
            
            if (window.MarketData && window.MarketData.showNotification) {
                window.MarketData.showNotification('Cache data exported successfully!', 'success');
            }
        }
        
        /**
         * Auto-refresh cache stats every 5 seconds
         */
        setInterval(() => {
            if (cacheWidgetOpen) {
                refreshCacheStats();
            } else {
                // Juste mettre Ã  jour le badge
                let entries = 0;
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('md_cache_')) {
                        entries++;
                    }
                }
                const badgeEl = document.getElementById('cacheBadge');
                const badgeMiniEl = document.getElementById('cacheBadgeMini');
                if (badgeEl) badgeEl.textContent = entries;
                if (badgeMiniEl) badgeMiniEl.textContent = entries;
            }
        }, 5000);
        
        /**
         * Exposer l'objet cacheWidget globalement
         */
        window.cacheWidget = {
            updateRateLimitStatus: function(remaining, max) {
                const remainingEl = document.getElementById('rateLimitRemaining');
                const progressEl = document.getElementById('rateLimitProgress');
                
                if (remainingEl) {
                    remainingEl.textContent = remaining;
                }
                
                if (progressEl) {
                    const percentage = (remaining / max) * 100;
                    progressEl.style.width = percentage + '%';
                    
                    // Couleur selon le pourcentage
                    if (percentage > 50) {
                        progressEl.style.background = 'linear-gradient(90deg, #10b981, #059669)';
                    } else if (percentage > 25) {
                        progressEl.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
                    } else {
                        progressEl.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                    }
                }
            },
            
            updateQueueStatus: function(length, waitTime) {
                const queueEl = document.getElementById('queueLength');
                
                if (queueEl) {
                    queueEl.textContent = length;
                    
                    if (length > 0) {
                        queueEl.style.color = '#ef4444';
                        queueEl.style.fontWeight = '700';
                    } else {
                        queueEl.style.color = '';
                        queueEl.style.fontWeight = '';
                    }
                }
            },
            
            logActivity: function(type, symbol, fromCache) {
                const activityEl = document.getElementById('cacheActivity');
                if (!activityEl) return;
                
                const now = new Date().toLocaleTimeString('fr-FR');
                const icon = fromCache ? 'ðŸ’¾' : 'ðŸŒ';
                const source = fromCache ? 'Cache' : 'API';
                
                const entry = document.createElement('div');
                entry.className = 'cache-activity-entry';
                entry.innerHTML = `
                    <span class='cache-activity-time'>${now}</span>
                    <span class='cache-activity-icon'>${icon}</span>
                    <span class='cache-activity-text'>${type} ${symbol} from ${source}</span>
                `;
                
                // InsÃ©rer en premier
                if (activityEl.firstChild && activityEl.firstChild.classList.contains('cache-empty-state')) {
                    activityEl.innerHTML = '';
                }
                activityEl.insertBefore(entry, activityEl.firstChild);
                
                // Garder seulement les 10 derniÃ¨res
                while (activityEl.children.length > 10) {
                    activityEl.removeChild(activityEl.lastChild);
                }
                
                // Mettre Ã  jour les stats
                if (fromCache) {
                    cacheStats.hits++;
                } else {
                    cacheStats.misses++;
                }
            }
        };
        
        // Initialiser au chargement
        document.addEventListener('DOMContentLoaded', () => {
            refreshCacheStats();
        });
    </script>
    
    <!-- Portfolio Modal Management Script -->
    <script>
        /**
         * ðŸ”“ Ouvre le modal des portfolios
         */
        async function openPortfoliosModal() {
            console.log('ðŸ”“ Opening Portfolios Modal...');
            
            const modal = document.getElementById('portfoliosModal');
            const container = document.getElementById('portfoliosListContainer');
            
            if (!modal || !container) {
                console.error('âŒ Modal or container not found');
                return;
            }
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            container.innerHTML = `
                <div class='loading-simulations'>
                    <i class='fas fa-spinner fa-spin'></i> Loading portfolios...
                </div>
            `;
            
            try {
                if (typeof MarketData !== 'undefined' && MarketData.refreshPortfoliosList) {
                    await MarketData.refreshPortfoliosList();
                    console.log('âœ… Portfolios loaded successfully');
                } else if (typeof PortfolioManager !== 'undefined') {
                    await PortfolioManager.fetchPortfoliosList();
                    console.log('âœ… Portfolios loaded successfully');
                } else {
                    console.error('âŒ PortfolioManager not found');
                    container.innerHTML = `
                        <div class='no-portfolios'>
                            <i class='fas fa-exclamation-triangle' style='font-size: 3em; margin-bottom: 15px; color: #e74c3c;'></i>
                            <p>Error: Portfolio Manager not loaded</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('âŒ Error loading portfolios:', error);
                container.innerHTML = `
                    <div class='no-portfolios'>
                        <i class='fas fa-exclamation-triangle' style='font-size: 3em; margin-bottom: 15px; color: #e74c3c;'></i>
                        <p>Error loading portfolios</p>
                        <p style='font-size: 0.9em; margin-top: 10px;'>${error.message}</p>
                    </div>
                `;
            }
        }
        
        /**
         * ðŸ”’ Ferme le modal des portfolios
         */
        function closePortfoliosModal() {
            const modal = document.getElementById('portfoliosModal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        /**
         * ðŸ“‹ Ouvre un modal gÃ©nÃ©rique
         */
        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            } else {
                console.warn('âš ï¸ Modal not found:', modalId);
            }
        }
        
        /**
         * ðŸ“‹ Ferme un modal gÃ©nÃ©rique
         */
        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        /**
         * ðŸšª Ferme le modal si on clique Ã  l'extÃ©rieur
         */
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
                document.body.style.overflow = '';
            }
        });
        
        /**
         * âŒ¨ï¸ Ferme les modals avec la touche Escape
         */
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal.active').forEach(modal => {
                    modal.classList.remove('active');
                });
                document.body.style.overflow = '';
            }
        });
        
        /**
         * âœ… Exposer les fonctions du PortfolioManager au chargement
         */
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof PortfolioManager !== 'undefined') {
                window.loadAndClosePortfolio = PortfolioManager.loadAndClosePortfolio;
                window.renamePortfolioAndRefresh = PortfolioManager.renamePortfolioAndRefresh;
                window.deletePortfolioAndRefresh = PortfolioManager.deletePortfolioAndRefresh;
                console.log('âœ… PortfolioManager functions exposed globally');
            }
        });
    </script>
    
    <!-- Core Scripts -->
    <script src='assets/js/config.js'></script>
    <script src='assets/js/api-client.js'></script>
    <script src='assets/js/dark-mode.js'></script>
    <script src='assets/js/common.js'></script>
    <script src='assets/js/sidebar.js'></script>
    
    <!-- Portfolio Manager (DOIT Ãªtre chargÃ© AVANT market-data.js) -->
    <script src='assets/js/portfolio-manager.js'></script>
    
    <!-- Market Data Script (VERSION OPTIMISÃ‰E AVEC RATE LIMITING) -->
    <script src='assets/js/market-data.js'></script>
    
    <!-- ============================================
         âœ… FIX MENU UTILISATEUR - Force l'initialisation
         ============================================ -->
    <script>
        /**
         * Force l'initialisation du menu utilisateur
         */
        (function forceUserMenuInit() {
            console.log('ðŸ”§ Force initializing user menu...');
            
            const initMenu = () => {
                const trigger = document.getElementById('sidebarUserTrigger');
                const dropdown = document.getElementById('sidebarUserDropdown');
                
                if (!trigger || !dropdown) {
                    console.error('âŒ User menu elements not found');
                    return;
                }
                
                // Supprimer tous les anciens event listeners
                const newTrigger = trigger.cloneNode(true);
                trigger.parentNode.replaceChild(newTrigger, trigger);
                
                const freshTrigger = document.getElementById('sidebarUserTrigger');
                const freshDropdown = document.getElementById('sidebarUserDropdown');
                
                console.log('âœ… Adding click event to trigger...');
                
                freshTrigger.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    console.log('ðŸ‘† User menu trigger clicked!');
                    
                    const isActive = freshDropdown.classList.contains('active');
                    
                    if (isActive) {
                        freshDropdown.classList.remove('active');
                        console.log('ðŸ”½ Closing dropdown');
                    } else {
                        freshDropdown.classList.add('active');
                        console.log('ðŸ”¼ Opening dropdown');
                    }
                    
                    const arrow = freshTrigger.querySelector('.sidebar-user-arrow');
                    if (arrow) {
                        arrow.style.transform = isActive ? 'rotate(0deg)' : 'rotate(180deg)';
                        arrow.style.transition = 'transform 0.3s ease';
                    }
                });
                
                // Fermer si on clique ailleurs
                document.addEventListener('click', function(e) {
                    if (!freshTrigger.contains(e.target) && !freshDropdown.contains(e.target)) {
                        freshDropdown.classList.remove('active');
                        const arrow = freshTrigger.querySelector('.sidebar-user-arrow');
                        if (arrow) {
                            arrow.style.transform = 'rotate(0deg)';
                        }
                    }
                });
                
                // EmpÃªcher la fermeture si on clique dans le dropdown
                freshDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
                
                console.log('âœ… User menu initialized successfully!');
            };
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initMenu);
            } else {
                setTimeout(initMenu, 100);
            }
        })();
    </script>
</body>
</html>