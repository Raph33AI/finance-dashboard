<!DOCTYPE html>
<html>
<head>
    <title>Migration - User Points</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="assets/js/firebase-config.js"></script>
</head>
<body style="font-family: sans-serif; padding: 40px; background: #f5f5f5;">
    <h1>üîß Migration - User Points</h1>
    <p>Ce script va recalculer les points de tous les utilisateurs existants.</p>
    
    <button id="startMigration" style="padding: 12px 24px; background: #3B82F6; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 700;">
        ‚ñ∂ D√©marrer la Migration
    </button>
    
    <div id="progress" style="margin-top: 24px; padding: 20px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"></div>

    <script>
        const db = firebase.firestore();

        async function recalculateUserPoints(userId) {
            const userRef = db.collection('users').doc(userId);
            const userDoc = await userRef.get();

            if (!userDoc.exists) return 0;

            const postsSnapshot = await db.collection('posts')
                .where('authorId', '==', userId)
                .get();

            let totalLikes = 0;
            postsSnapshot.docs.forEach(doc => {
                const post = doc.data();
                totalLikes += (post.likes?.length || 0);
            });

            const commentsSnapshot = await db.collection('comments')
                .where('authorId', '==', userId)
                .get();

            const points = 
                (postsSnapshot.size * 10) +
                (totalLikes * 2) +
                (commentsSnapshot.size * 3);

            await userRef.update({
                points: points,
                postsCount: postsSnapshot.size,
                commentsCount: commentsSnapshot.size,
                likesReceived: totalLikes,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            return points;
        }

        document.getElementById('startMigration').addEventListener('click', async () => {
            const progressDiv = document.getElementById('progress');
            progressDiv.innerHTML = '<p>‚è≥ Migration en cours...</p>';

            try {
                const usersSnapshot = await db.collection('users').get();
                const totalUsers = usersSnapshot.size;
                let processed = 0;

                progressDiv.innerHTML += `<p>üë• ${totalUsers} utilisateurs trouv√©s</p>`;

                for (const userDoc of usersSnapshot.docs) {
                    const userId = userDoc.id;
                    const points = await recalculateUserPoints(userId);
                    processed++;

                    progressDiv.innerHTML += `<p>‚úÖ ${userDoc.data().displayName || userId}: ${points} points (${processed}/${totalUsers})</p>`;
                }

                progressDiv.innerHTML += '<p style="color: #10B981; font-weight: 700; font-size: 1.2rem;">üéâ Migration termin√©e !</p>';

            } catch (error) {
                progressDiv.innerHTML += `<p style="color: #EF4444;">‚ùå Erreur: ${error.message}</p>`;
                console.error(error);
            }
        });
    </script>
</body>
</html>