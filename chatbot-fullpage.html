/**
 * ============================================
 * ü§ñ CHATBOT FULLPAGE UI - ULTRA-PREMIUM
 * ============================================
 * Gestion compl√®te de l'interface du chatbot
 * - Conversations multiples
 * - Int√©gration AI Gemini
 * - Graphiques interactifs
 * - Export/Partage
 * - Animations 3D
 * ============================================
 */

class ChatbotFullpageUI {
    constructor() {
        console.log('ü§ñ Initializing ChatbotFullpageUI...');
        
        // DOM Elements
        this.messagesContent = document.getElementById('chatbot-messages-content');
        this.inputField = document.getElementById('chatbot-input');
        this.sendBtn = document.getElementById('chatbot-send-btn');
        this.newChatBtn = document.getElementById('new-chat-btn');
        this.conversationsList = document.getElementById('conversations-list');
        this.conversationsSidebar = document.getElementById('conversations-sidebar');
        this.conversationsToggle = document.getElementById('conversations-toggle');
        this.welcomeScreen = document.getElementById('welcome-screen');
        this.inputSuggestions = document.getElementById('input-suggestions');
        this.inputCounter = document.getElementById('input-counter');
        this.inputClearBtn = document.getElementById('input-clear-btn');
        
        // State
        this.conversations = [];
        this.currentConversationId = null;
        this.isProcessing = false;
        this.messageIdCounter = 0;
        
        // AI Engine
        this.aiEngine = null;
        
        // Initialize
        this.init();
    }
    
    async init() {
        try {
            // Load AI Engine
            if (typeof FinancialChatbotEngine !== 'undefined') {
                this.aiEngine = new FinancialChatbotEngine();
                console.log('‚úÖ AI Engine loaded');
            } else {
                console.warn('‚ö† AI Engine not found');
            }
            
            // Load saved conversations
            this.loadConversations();
            
            // Setup event listeners
            this.setupEventListeners();
            
            // Setup welcome suggestions
            this.setupWelcomeSuggestions();
            
            // Setup auto-resize textarea
            this.setupAutoResize();
            
            // Focus input
            this.inputField?.focus();
            
            console.log('‚úÖ ChatbotFullpageUI initialized successfully');
        } catch (error) {
            console.error('‚ùå Initialization error:', error);
        }
    }
    
    // ============================================
    // EVENT LISTENERS
    // ============================================
    
    setupEventListeners() {
        // Send message
        this.sendBtn?.addEventListener('click', () => this.handleSendMessage());
        
        // Enter to send (Ctrl+Enter for new line)
        this.inputField?.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !e.ctrlKey) {
                e.preventDefault();
                this.handleSendMessage();
            }
            if (e.key === 'Enter' && e.ctrlKey) {
                this.handleSendMessage();
            }
        });
        
        // Input counter
        this.inputField?.addEventListener('input', () => {
            const length = this.inputField.value.length;
            if (this.inputCounter) {
                this.inputCounter.textContent = `${length}/2000`;
                this.inputCounter.style.color = length > 1800 ? '#ef4444' : '';
            }
            
            // Show/hide clear button
            if (this.inputClearBtn) {
                this.inputClearBtn.style.display = length > 0 ? 'flex' : 'none';
            }
        });
        
        // Clear input
        this.inputClearBtn?.addEventListener('click', () => {
            this.inputField.value = '';
            this.inputField.dispatchEvent(new Event('input'));
            this.inputField.focus();
        });
        
        // New chat
        this.newChatBtn?.addEventListener('click', () => this.createNewConversation());
        
        // Toggle conversations sidebar
        this.conversationsToggle?.addEventListener('click', () => {
            this.conversationsSidebar?.classList.toggle('collapsed');
            const icon = this.conversationsToggle.querySelector('i');
            if (icon) {
                icon.className = this.conversationsSidebar.classList.contains('collapsed') 
                    ? 'fas fa-chevron-right' 
                    : 'fas fa-chevron-left';
            }
        });
        
        // ESC to clear input
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.activeElement === this.inputField) {
                this.inputField.value = '';
                this.inputField.dispatchEvent(new Event('input'));
            }
            
            // / to focus input
            if (e.key === '/' && document.activeElement !== this.inputField) {
                e.preventDefault();
                this.inputField?.focus();
            }
            
            // Ctrl+N for new chat
            if (e.ctrlKey && e.key === 'n') {
                e.preventDefault();
                this.createNewConversation();
            }
        });
    }
    
    setupWelcomeSuggestions() {
        const suggestionBtns = document.querySelectorAll('.welcome-suggestion-btn');
        suggestionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const query = btn.dataset.query;
                if (query) {
                    this.inputField.value = query;
                    this.handleSendMessage();
                }
            });
        });
    }
    
    setupAutoResize() {
        if (!this.inputField) return;
        
        this.inputField.addEventListener('input', () => {
            this.inputField.style.height = 'auto';
            const newHeight = Math.min(this.inputField.scrollHeight, 150);
            this.inputField.style.height = newHeight + 'px';
        });
    }
    
    // ============================================
    // CONVERSATION MANAGEMENT
    // ============================================
    
    createNewConversation() {
        const conversationId = this.generateConversationId();
        const conversation = {
            id: conversationId,
            title: 'New Conversation',
            messages: [],
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        
        this.conversations.unshift(conversation);
        this.currentConversationId = conversationId;
        
        // Clear messages
        this.clearMessages();
        
        // Show welcome screen
        if (this.welcomeScreen) {
            this.welcomeScreen.style.display = 'block';
        }
        
        // Update UI
        this.updateConversationsList();
        this.saveConversations();
        
        // Focus input
        this.inputField?.focus();
        
        console.log('‚úÖ New conversation created:', conversationId);
    }
    
    loadConversations() {
        try {
            const saved = localStorage.getItem('chatbotConversations');
            if (saved) {
                this.conversations = JSON.parse(saved);
                console.log(`üìö Loaded ${this.conversations.length} conversations`);
            }
            
            // Create first conversation if none exist
            if (this.conversations.length === 0) {
                this.createNewConversation();
            } else {
                // Load most recent
                this.currentConversationId = this.conversations[0].id;
                this.loadConversationMessages(this.currentConversationId);
            }
            
            this.updateConversationsList();
        } catch (error) {
            console.error('‚ùå Error loading conversations:', error);
            this.createNewConversation();
        }
    }
    
    saveConversations() {
        try {
            localStorage.setItem('chatbotConversations', JSON.stringify(this.conversations));
            console.log('üíæ Conversations saved');
        } catch (error) {
            console.error('‚ùå Error saving conversations:', error);
        }
    }
    
    getCurrentConversation() {
        return this.conversations.find(c => c.id === this.currentConversationId);
    }
    
    updateConversationTitle(conversationId, title) {
        const conversation = this.conversations.find(c => c.id === conversationId);
        if (conversation) {
            conversation.title = title;
            conversation.updatedAt = new Date().toISOString();
            this.updateConversationsList();
            this.saveConversations();
        }
    }
    
    deleteConversation(conversationId) {
        if (confirm('Delete this conversation?')) {
            this.conversations = this.conversations.filter(c => c.id !== conversationId);
            
            if (this.currentConversationId === conversationId) {
                if (this.conversations.length > 0) {
                    this.switchConversation(this.conversations[0].id);
                } else {
                    this.createNewConversation();
                }
            }
            
            this.updateConversationsList();
            this.saveConversations();
        }
    }
    
    switchConversation(conversationId) {
        this.currentConversationId = conversationId;
        this.loadConversationMessages(conversationId);
        this.updateConversationsList();
        
        // Update active state
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.toggle('active', item.dataset.conversationId === conversationId);
        });
    }
    
    loadConversationMessages(conversationId) {
        const conversation = this.conversations.find(c => c.id === conversationId);
        if (!conversation) return;
        
        // Clear current messages
        this.clearMessages();
        
        // Hide welcome screen if there are messages
        if (conversation.messages.length > 0 && this.welcomeScreen) {
            this.welcomeScreen.style.display = 'none';
        }
        
        // Load messages
        conversation.messages.forEach(msg => {
            this.displayMessage(msg.text, msg.role, false, msg.hasChart);
        });
        
        // Scroll to bottom
        this.scrollToBottom();
    }
    
    updateConversationsList() {
        if (!this.conversationsList) return;
        
        this.conversationsList.innerHTML = '';
        
        if (this.conversations.length === 0) {
            this.conversationsList.innerHTML = `
                <div class="conversations-empty">
                    <i class="fas fa-comments"></i>
                    <p>No conversations yet</p>
                </div>
            `;
            return;
        }
        
        this.conversations.forEach(conversation => {
            const item = document.createElement('div');
            item.className = 'conversation-item';
            item.dataset.conversationId = conversation.id;
            
            if (conversation.id === this.currentConversationId) {
                item.classList.add('active');
            }
            
            const date = new Date(conversation.updatedAt);
            const timeAgo = this.getTimeAgo(date);
            
            item.innerHTML = `
                <div class="conversation-icon">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <div class="conversation-details">
                    <h4 class="conversation-title">${this.escapeHtml(conversation.title)}</h4>
                    <p class="conversation-preview">${conversation.messages.length} messages</p>
                    <span class="conversation-time">${timeAgo}</span>
                </div>
                <div class="conversation-actions">
                    <button class="conversation-action-btn delete-btn" title="Delete">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            
            // Click to switch
            item.addEventListener('click', (e) => {
                if (!e.target.closest('.conversation-actions')) {
                    this.switchConversation(conversation.id);
                }
            });
            
            // Delete button
            const deleteBtn = item.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                this.deleteConversation(conversation.id);
            });
            
            this.conversationsList.appendChild(item);
        });
    }
    
    // ============================================
    // MESSAGE HANDLING
    // ============================================
    
    async handleSendMessage() {
        const message = this.inputField.value.trim();
        
        if (!message || this.isProcessing) return;
        
        // Hide welcome screen
        if (this.welcomeScreen) {
            this.welcomeScreen.style.display = 'none';
        }
        
        // Display user message
        this.displayMessage(message, 'user');
        
        // Save to conversation
        this.addMessageToConversation(message, 'user');
        
        // Update conversation title if first message
        const conversation = this.getCurrentConversation();
        if (conversation && conversation.messages.length === 1) {
            const title = message.slice(0, 50) + (message.length > 50 ? '...' : '');
            this.updateConversationTitle(conversation.id, title);
        }
        
        // Clear input
        this.inputField.value = '';
        this.inputField.style.height = 'auto';
        this.inputField.dispatchEvent(new Event('input'));
        
        // Process with AI
        this.isProcessing = true;
        this.updateSendButton(true);
        
        try {
            await this.processAIResponse(message);
        } catch (error) {
            console.error('‚ùå Error processing message:', error);
            this.displayMessage('Sorry, I encountered an error. Please try again.', 'assistant', true);
        } finally {
            this.isProcessing = false;
            this.updateSendButton(false);
            this.inputField?.focus();
        }
    }
    
    async processAIResponse(userMessage) {
        // Show typing indicator
        const typingId = this.showTypingIndicator();
        
        try {
            if (!this.aiEngine) {
                throw new Error('AI Engine not available');
            }
            
            // Get conversation context
            const conversation = this.getCurrentConversation();
            const context = conversation ? conversation.messages.slice(-5) : [];
            
            // Process with AI
            const response = await this.aiEngine.processMessage(userMessage, context);
            
            // Remove typing indicator
            this.removeTypingIndicator(typingId);
            
            // Display response
            if (response.text) {
                this.displayMessage(response.text, 'assistant', false, response.hasChart);
                this.addMessageToConversation(response.text, 'assistant', response.hasChart);
            }
            
        } catch (error) {
            console.error('‚ùå AI processing error:', error);
            this.removeTypingIndicator(typingId);
            
            const errorMessage = error.message || 'Sorry, I encountered an error processing your request.';
            this.displayMessage(errorMessage, 'assistant', true);
            this.addMessageToConversation(errorMessage, 'assistant');
        }
    }
    
    displayMessage(text, role, isError = false, hasChart = false) {
        const messageContainer = document.createElement('div');
        messageContainer.className = `chatbot-message ${role}-message`;
        if (isError) messageContainer.classList.add('error-message');
        
        const avatar = document.createElement('div');
        avatar.className = 'message-avatar';
        
        if (role === 'user') {
            // Get user photo from Firebase or default
            const userPhoto = document.querySelector('[data-user-photo]')?.src || 
                            'https://ui-avatars.com/api/?name=User&background=667eea&color=fff';
            avatar.innerHTML = `<img src="${userPhoto}" alt="User">`;
        } else {
            avatar.innerHTML = `
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
            `;
        }
        
        const messageContent = document.createElement('div');
        messageContent.className = 'message-content';
        
        const messageText = document.createElement('div');
        messageText.className = 'message-text';
        
        // Format text with markdown-like styling
        messageText.innerHTML = this.formatMessageText(text);
        
        const messageTime = document.createElement('div');
        messageTime.className = 'message-time';
        messageTime.textContent = new Date().toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        messageContent.appendChild(messageText);
        messageContent.appendChild(messageTime);
        
        messageContainer.appendChild(avatar);
        messageContainer.appendChild(messageContent);
        
        // Insert before typing indicator or append
        const typingIndicator = this.messagesContent.querySelector('.typing-indicator-container');
        if (typingIndicator) {
            this.messagesContent.insertBefore(messageContainer, typingIndicator);
        } else {
            this.messagesContent.appendChild(messageContainer);
        }
        
        // Animate in
        requestAnimationFrame(() => {
            messageContainer.style.opacity = '0';
            messageContainer.style.transform = 'translateY(20px)';
            requestAnimationFrame(() => {
                messageContainer.style.transition = 'all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
                messageContainer.style.opacity = '1';
                messageContainer.style.transform = 'translateY(0)';
            });
        });
        
        this.scrollToBottom();
    }
    
    formatMessageText(text) {
        // Escape HTML
        let formatted = this.escapeHtml(text);
        
        // Bold **text**
        formatted = formatted.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
        
        // Italic *text*
        formatted = formatted.replace(/\*(.+?)\*/g, '<em>$1</em>');
        
        // Code `code`
        formatted = formatted.replace(/`(.+?)`/g, '<code>$1</code>');
        
        // Links [text](url)
        formatted = formatted.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank" rel="noopener">$1</a>');
        
        // Line breaks
        formatted = formatted.replace(/\n/g, '<br>');
        
        // Lists
        formatted = formatted.replace(/^- (.+)$/gm, '<li>$1</li>');
        formatted = formatted.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        
        // Numbers with $ sign
        formatted = formatted.replace(/\$(\d+(?:\.\d{2})?)/g, '<span class="money-value">$$$1</span>');
        
        // Percentages
        formatted = formatted.replace(/(\d+(?:\.\d+)?%)/g, '<span class="percent-value">$1</span>');
        
        return formatted;
    }
    
    showTypingIndicator() {
        const typingId = `typing-${Date.now()}`;
        const typingContainer = document.createElement('div');
        typingContainer.className = 'typing-indicator-container';
        typingContainer.id = typingId;
        
        typingContainer.innerHTML = `
            <div class="message-avatar">
                <div class="ai-avatar">
                    <i class="fas fa-robot"></i>
                </div>
            </div>
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;
        
        this.messagesContent.appendChild(typingContainer);
        this.scrollToBottom();
        
        return typingId;
    }
    
    removeTypingIndicator(typingId) {
        const indicator = document.getElementById(typingId);
        if (indicator) {
            indicator.style.opacity = '0';
            setTimeout(() => indicator.remove(), 300);
        }
    }
    
    addMessageToConversation(text, role, hasChart = false) {
        const conversation = this.getCurrentConversation();
        if (!conversation) return;
        
        conversation.messages.push({
            id: this.generateMessageId(),
            text,
            role,
            hasChart,
            timestamp: new Date().toISOString()
        });
        
        conversation.updatedAt = new Date().toISOString();
        this.saveConversations();
    }
    
    clearMessages() {
        const messages = this.messagesContent.querySelectorAll('.chatbot-message, .typing-indicator-container');
        messages.forEach(msg => msg.remove());
    }
    
    // ============================================
    // UI UPDATES
    // ============================================
    
    updateSendButton(isProcessing) {
        if (!this.sendBtn) return;
        
        const icon = this.sendBtn.querySelector('i');
        if (isProcessing) {
            this.sendBtn.disabled = true;
            this.sendBtn.classList.add('processing');
            if (icon) {
                icon.className = 'fas fa-spinner fa-spin';
            }
        } else {
            this.sendBtn.disabled = false;
            this.sendBtn.classList.remove('processing');
            if (icon) {
                icon.className = 'fas fa-paper-plane';
            }
        }
    }
    
    scrollToBottom(smooth = true) {
        if (!this.messagesContent) return;
        
        requestAnimationFrame(() => {
            this.messagesContent.scrollTo({
                top: this.messagesContent.scrollHeight,
                behavior: smooth ? 'smooth' : 'auto'
            });
        });
    }
    
    // ============================================
    // HELPERS
    // ============================================
    
    generateConversationId() {
        return `conv_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    }
    
    generateMessageId() {
        return `msg_${Date.now()}_${this.messageIdCounter++}`;
    }
    
    escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    getTimeAgo(date) {
        const seconds = Math.floor((new Date() - date) / 1000);
        
        if (seconds < 60) return 'Just now';
        if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
        if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
        if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
        
        return date.toLocaleDateString();
    }
    
    // ============================================
    // PUBLIC API
    // ============================================
    
    sendMessage(message) {
        this.inputField.value = message;
        this.handleSendMessage();
    }
    
    clearCurrentConversation() {
        const conversation = this.getCurrentConversation();
        if (conversation && confirm('Clear all messages in this conversation?')) {
            conversation.messages = [];
            this.clearMessages();
            if (this.welcomeScreen) {
                this.welcomeScreen.style.display = 'block';
            }
            this.saveConversations();
        }
    }
}

// ============================================
// INITIALIZATION
// ============================================

let chatbotUI = null;

document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ Initializing Chatbot UI...');
    
    // Wait for AI Engine to be ready
    const initUI = () => {
        try {
            chatbotUI = new ChatbotFullpageUI();
            window.chatbotUI = chatbotUI; // Expose globally
            console.log('‚úÖ Chatbot UI ready');
        } catch (error) {
            console.error('‚ùå Failed to initialize Chatbot UI:', error);
        }
    };
    
    // Check if AI Engine is loaded
    if (typeof FinancialChatbotEngine !== 'undefined') {
        initUI();
    } else {
        // Wait a bit for other scripts to load
        setTimeout(initUI, 500);
    }
});

// ============================================
// EXPORT
// ============================================

if (typeof module !== 'undefined' && module.exports) {
    module.exports = ChatbotFullpageUI;
}