<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>Financial Dashboard - Raphael NARDONE</title>
    <script src='https://code.highcharts.com/highcharts.js'></script>
    <script src='https://code.highcharts.com/modules/exporting.js'></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #5B2C6F 0%, #2649B2 50%, #4A74F3 100%); padding: 20px; color: #333; }
        .container { max-width: 1800px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(91,44,111,0.4); overflow: hidden; }
        header { background: linear-gradient(135deg, #2649B2 0%, #6C3483 50%, #8E44AD 100%); color: white; padding: 30px; text-align: center; }
        header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 8px rgba(0,0,0,0.3); }
        header p { font-size: 1.1em; opacity: 0.95; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; padding: 30px; background: linear-gradient(135deg, #E8DAEF 0%, #D4D9F0 100%); }
        .stat-card { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 4px 12px rgba(108,52,131,0.15); text-align: center; transition: all 0.3s; border-left: 4px solid #8E44AD; }
        .stat-card:hover { transform: translateY(-5px); box-shadow: 0 8px 20px rgba(108,52,131,0.25); }
        .stat-card h3 { font-size: 0.9em; color: #5B2C6F; margin-bottom: 10px; text-transform: uppercase; font-weight: 600; }
        .stat-card .value { font-size: 2em; font-weight: bold; background: linear-gradient(135deg, #2649B2 0%, #8E44AD 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card.positive .value { background: linear-gradient(135deg, #4A74F3 0%, #6C8BE0 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .stat-card.negative .value { background: linear-gradient(135deg, #6C3483 0%, #5B2C6F 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .section-title { font-size: 1.5em; color: #2649B2; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 3px solid #E8DAEF; }
        footer { background: linear-gradient(135deg, #2649B2 0%, #6C3483 100%); color: white; text-align: center; padding: 20px; }
        
        /* TABLE STYLES */
        .data-section { padding: 30px; background: white; }
        .toolbar { background: linear-gradient(135deg, #E8DAEF 0%, #D4D9F0 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .toolbar h3 { color: #2649B2; margin-bottom: 15px; }
        .toolbar-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
        .toolbar-row:last-child { margin-bottom: 0; }
        .toolbar label { font-weight: bold; color: #5B2C6F; font-size: 0.9em; min-width: 80px; }
        .toolbar input, .toolbar select { padding: 10px; border: 2px solid #9D5CE6; border-radius: 8px; font-size: 0.95em; }
        .toolbar input:focus, .toolbar select:focus { outline: none; border-color: #2649B2; box-shadow: 0 0 0 3px rgba(38,73,178,0.2); }
        .btn-primary { background: linear-gradient(135deg, #2649B2 0%, #8E44AD 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(38,73,178,0.4); }
        .btn-secondary { background: linear-gradient(135deg, #6C3483 0%, #9D5CE6 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-secondary:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(108,52,131,0.4); }
        .btn-success { background: linear-gradient(135deg, #4A74F3 0%, #6C8BE0 100%); color: white; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        .btn-success:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(74,116,243,0.4); }
        .btn-add { background: linear-gradient(135deg, #2649B2 0%, #4A74F3 100%); color: white; padding: 10px 25px; border: none; border-radius: 8px; font-size: 0.95em; font-weight: bold; cursor: pointer; margin: 5px; }
        .btn-add:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(38,73,178,0.4); }
        
        .table-container { overflow-x: auto; max-height: 600px; overflow-y: auto; border-radius: 10px; box-shadow: 0 4px 12px rgba(108,52,131,0.15); }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .data-table thead { background: linear-gradient(135deg, #2649B2 0%, #8E44AD 100%); color: white; position: sticky; top: 0; z-index: 10; }
        .data-table th { padding: 12px 8px; text-align: left; font-weight: bold; white-space: nowrap; border-right: 1px solid rgba(255,255,255,0.2); font-size: 0.85em; }
        .data-table th:first-child { position: sticky; left: 0; z-index: 11; background: linear-gradient(135deg, #2649B2 0%, #8E44AD 100%); }
        .data-table tbody tr { border-bottom: 1px solid #E8DAEF; transition: background 0.2s; }
        .data-table tbody tr:hover { background: #F8F9FA; }
        .data-table tbody tr:nth-child(even) { background: #FAFBFC; }
        .data-table tbody tr:nth-child(even):hover { background: #F0F2F5; }
        .data-table td { padding: 6px 4px; border-right: 1px solid #E8DAEF; }
        .data-table td:first-child { position: sticky; left: 0; background: white; font-weight: bold; color: #2649B2; z-index: 1; font-size: 0.8em; }
        .data-table tbody tr:nth-child(even) td:first-child { background: #FAFBFC; }
        .data-table tbody tr:hover td:first-child { background: #F8F9FA; }
        .data-table tbody tr:nth-child(even):hover td:first-child { background: #F0F2F5; }
        .data-table input { width: 80px; padding: 4px; border: 1px solid #D4D9F0; border-radius: 4px; font-size: 0.85em; text-align: right; }
        .data-table input:focus { outline: none; border-color: #2649B2; background: #F0F7FF; }
        .data-table .calculated { background: #E8DAEF; font-weight: bold; color: #5B2C6F; text-align: right; padding: 6px 8px; font-size: 0.85em; }
        .data-table .btn-delete { background: #9D5CE6; color: white; border: none; padding: 3px 8px; border-radius: 4px; cursor: pointer; font-size: 0.75em; }
        .data-table .btn-delete:hover { background: #8E44AD; }
        
        .charts-container { padding: 30px; background: linear-gradient(to bottom, #f8f9fa 0%, #E8DAEF 100%); }
        .chart-wrapper { background: white; margin-bottom: 30px; border-radius: 15px; box-shadow: 0 4px 12px rgba(108,52,131,0.12); padding: 20px; border-top: 3px solid #8E44AD; }
        .chart { min-height: 400px; }
        .grid-2 { display: grid; grid-template-columns: repeat(auto-fit, minmax(600px, 1fr)); gap: 30px; }
        .local-filter { margin: 15px 0; padding: 15px; background: linear-gradient(135deg, #E8DAEF 0%, #D4D9F0 100%); border-radius: 10px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; border-left: 4px solid #8E44AD; }
        .local-filter label { font-weight: bold; color: #5B2C6F; font-size: 0.9em; }
        .local-filter select { padding: 8px 15px; border: 2px solid #9D5CE6; border-radius: 8px; font-size: 0.9em; min-width: 200px; cursor: pointer; background: white; color: #2649B2; font-weight: 500; }
        .info-box { background: linear-gradient(135deg, #4A74F3 0%, #6C8BE0 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .info-box h4 { margin-bottom: 10px; }
        .info-box p { font-size: 0.9em; opacity: 0.95; }
        @media (max-width: 768px) { .grid-2 { grid-template-columns: 1fr; } .toolbar-row { flex-direction: column; align-items: stretch; } }
    </style>
</head>
<body>
    <div class='container'>
        <header>
            <h1>Personal Finance Dashboard</h1>
            <p>Raphael NARDONE | Dynamic Timeline | Auto-saved | Last update: 10/27/2025 21:57</p>
        </header>
        <nav style='background: linear-gradient(135deg, #2649B2 0%, #8E44AD 100%); padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.2);'>
            <div style='max-width: 1800px; margin: 0 auto; display: flex; gap: 0;'>
                <a href='dashboard-financier.html' style='flex: 1; padding: 20px; text-align: center; color: white; text-decoration: none; background: rgba(255,255,255,0.2); font-weight: bold; border-bottom: 4px solid white;'>Budget</a>
                <a href='monte-carlo.html' style='flex: 1; padding: 20px; text-align: center; color: white; text-decoration: none; transition: all 0.3s;' onmouseover='this.style.background="rgba(255,255,255,0.1)"' onmouseout='this.style.background="transparent"'>Monte Carlo</a>
                <a href='portfolio-optimizer.html' style='flex: 1; padding: 20px; text-align: center; color: white; text-decoration: none; transition: all 0.3s;' onmouseover='this.style.background="rgba(255,255,255,0.1)"' onmouseout='this.style.background="transparent"'>Markowitz</a>
                <a href='risk-parity.html' style='flex: 1; padding: 20px; text-align: center; color: white; text-decoration: none; transition: all 0.3s;' onmouseover='this.style.background="rgba(255,255,255,0.1)"' onmouseout='this.style.background="transparent"'>Risk Parity</a>
                <a href='scenario-analysis.html' style='flex: 1; padding: 20px; text-align: center; color: white; text-decoration: none; transition: all 0.3s;' onmouseover='this.style.background="rgba(255,255,255,0.1)"' onmouseout='this.style.background="transparent"'>Scenarios</a>
            </div>
        </nav>
        <div id='statsContainer' class='stats-grid'></div>
        
        <div class='data-section'>
            <h2 class='section-title'>Financial Data - Dynamic Timeline</h2>
            
            <div class='info-box'>
                <h4>How to use</h4>
                <p>Edit values directly in the table | Use Bulk Edit to apply values to date ranges | Add past/future months with the buttons below | Adjust Monthly Est Yield to calculate gains automatically | All changes are auto-saved in your browser</p>
            </div>
            
            <div class='toolbar'>
                <h3>Timeline Management</h3>
                <div class='toolbar-row'>
                    <button class='btn-add' onclick='addMonthsBefore(12)'>+ 12 Months Before</button>
                    <button class='btn-add' onclick='addMonthsBefore(1)'>+ 1 Month Before</button>
                    <button class='btn-add' onclick='addMonthsAfter(1)'>+ 1 Month After</button>
                    <button class='btn-add' onclick='addMonthsAfter(12)'>+ 12 Months After</button>
                    <span style='color: #5B2C6F; font-weight: bold; margin-left: 20px;'>Total Months: <span id='totalMonthsDisplay'>300</span></span>
                </div>
            </div>
            
            <div style='display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;'>
                
                <div class='toolbar'>
                    <h3>Investment Parameters</h3>
                    <div class='toolbar-row'>
                        <label style='min-width: 200px;'>Monthly Est Yield (% annual):</label>
                        <input type='number' id='monthlyEstYield' step='0.1' value='8' style='width: 120px;' 
                               onchange='updateEstYield()'>
                        <span style='color: #2649B2; font-weight: bold; margin-left: 10px;'>
                            = <span id='monthlyEstYieldDisplay'>0.67</span>% monthly
                        </span>
                    </div>
                    <div class='toolbar-row'>
                        <button class='btn-primary' onclick='recalculateGains()'>Recalculate All Gains</button>
                    </div>
                </div>
                
                <div class='toolbar'>
                    <h3>Inflation Adjustment</h3>
                    <div class='toolbar-row'>
                        <label style='min-width: 200px;'>Annual Inflation Rate (%):</label>
                        <input type='number' id='inflationRate' step='0.1' value='2.5' style='width: 120px;' 
                               onchange='updateInflationRate()'>
                        <button class='btn-success' onclick='toggleInflationCharts()' id='btnToggleInflation'>
                            Show Inflation-Adjusted Charts
                        </button>
                        <span id='inflationStatus' style='color: #9D5CE6; font-weight: bold; margin-left: 15px;'>OFF</span>
                    </div>
                </div>
                
            </div>
            
            <div class='toolbar'>
                <h3>Bulk Edit Tool</h3>
                <div class='toolbar-row'>
                    <label>Category:</label>
                    <select id='bulkCategory' style='min-width: 200px;'>
                        <option value='Salary'>Income - Salary</option>
                        <option value='Misc.'>Income - Misc.</option>
                        <option value='Rent'>Expenses - Rent</option>
                        <option value='Food'>Expenses - Food</option>
                        <option value='Fix Costs'>Expenses - Fix Costs</option>
                        <option value='Others (Shopping; Restaurant…)'>Expenses - Others</option>
                        <option value='Investment'>Investment - Monthly Investment</option>
                        <option value='Loan (Studies; rental investment)'>Expenses - Loan</option>
                        <option value="PEE L'OREAL">Investment - PEE L'Oreal</option>
                    </select>
                </div>
                <div class='toolbar-row'>
                    <label>From:</label>
                    <input type='month' id='bulkStartMonth' style='min-width: 150px;'>
                    <label>To:</label>
                    <input type='month' id='bulkEndMonth' style='min-width: 150px;'>
                </div>
                <div class='toolbar-row'>
                    <label>Value:</label>
                    <input type='number' id='bulkValue' step='0.01' placeholder='0.00' style='min-width: 120px;'>
                    <button class='btn-success' onclick='applyBulkEdit()'>Apply</button>
                </div>
            </div>
            
            <div class='toolbar'>
                <h3>Data Management</h3>
                <div class='toolbar-row'>
                    <button class='btn-primary' onclick='saveData()'>Save All</button>
                    <button class='btn-secondary' onclick='exportToJSON()'>Export JSON</button>
                    <button class='btn-secondary' onclick='importFromJSON()'>Import JSON</button>
                    <button class='btn-secondary' onclick='resetToDefault()'>Reset</button>
                    <button class='btn-primary' onclick='updateAllCharts()'>Update Charts</button>
                </div>
            </div>
            
            <div class='table-container'>
                <table class='data-table'>
                    <thead>
                        <tr>
                            <th rowspan='2'>Month</th>
                            <th colspan='3' style='background: #4A74F3; text-align: center;'>INCOME</th>
                            <th colspan='7' style='background: #8E44AD; text-align: center;'>EXPENSES</th>
                            <th colspan='7' style='background: #6C3483; text-align: center;'>INVESTMENT</th>
                            <th rowspan='2' style='background: #9D5CE6;'>Actions</th>
                        </tr>
                        <tr>
                            <th style='background: #4A74F3;'>Salary</th>
                            <th style='background: #4A74F3;'>Misc.</th>
                            <th style='background: #6C8BE0;'>Total</th>
                            <th style='background: #8E44AD;'>Rent</th>
                            <th style='background: #8E44AD;'>Food</th>
                            <th style='background: #8E44AD;'>Fix</th>
                            <th style='background: #8E44AD;'>Others</th>
                            <th style='background: #8E44AD;'>Loan</th>
                            <th style='background: #9D5CE6;'>Total</th>
                            <th style='background: #9D5CE6;'>Save</th>
                            <th style='background: #6C3483;'>Monthly Invest</th>
                            <th style='background: #6C3483;'>Monthly Gain</th>
                            <th style='background: #6C3483;'>Cum. Gains</th>
                            <th style='background: #6C3483;'>PEE</th>
                            <th style='background: #9D5CE6;'>Cum.Inv</th>
                            <th style='background: #9D5CE6;'>Portfolio</th>
                            <th style='background: #9D5CE6;'>ROI%</th>
                        </tr>
                    </thead>
                    <tbody id='dataTableBody'></tbody>
                </table>
            </div>
        </div>
        
        <div class='charts-container'>
            <div class='chart-wrapper'>
                <h2 class='section-title'>Income vs Expenses Evolution</h2>
                <div id='chart1' class='chart'></div>
            </div>
            <div class='grid-2'>
                <div class='chart-wrapper'>
                    <h2 class='section-title'>Income Breakdown</h2>
                    <div class='local-filter'>
                        <label>Select Month:</label>
                        <select id='incomeMonthFilter' onchange='updateChart2()'></select>
                    </div>
                    <div id='chart2' class='chart'></div>
                </div>
                <div class='chart-wrapper'>
                    <h2 class='section-title'>Expenses Breakdown</h2>
                    <div class='local-filter'>
                        <label>Select Month:</label>
                        <select id='expenseMonthFilter' onchange='updateChart3()'></select>
                    </div>
                    <div id='chart3' class='chart'></div>
                </div>
            </div>
            <div class='chart-wrapper'>
                <h2 class='section-title'>Budget Allocation</h2>
                <div class='local-filter'>
                    <label>Select Month:</label>
                    <select id='budgetMonthFilter' onchange='updateChart7()'></select>
                </div>
                <div id='chart7' class='chart'></div>
            </div>
            <div class='chart-wrapper'>
                <h2 class='section-title'>Savings Evolution</h2>
                <div id='chart4' class='chart'></div>
            </div>
            <div class='grid-2'>
                <div class='chart-wrapper'>
                    <h2 class='section-title'>Investment Portfolio</h2>
                    <div id='chart5' class='chart'></div>
                </div>
                <div class='chart-wrapper'>
                    <h2 class='section-title'>ROI Evolution</h2>
                    <div id='chart6' class='chart'></div>
                </div>
            </div>
        </div>
        <footer><p>Financial Dashboard | Auto-saved in browser localStorage | Generated 10/27/2025 21:57</p></footer>
    </div>
    <script>
        let allData = [];
        let chart1Instance, chart4Instance, chart5Instance, chart6Instance;
        let currentMonthIndex = 0;
        let monthlyEstYield = 8; // % annual
        let inflationRate = 2.5; // % annual
        let showInflation = false;
        
        function generateMonths(startYear, startMonth, count) {
            const months = [];
            let year = startYear;
            let month = startMonth;
            
            for (let i = 0; i < count; i++) {
                months.push(String(month).padStart(2, '0') + '/' + year);
                month++;
                if (month > 12) { month = 1; year++; }
            }
            return months;
        }
        
        function findCurrentMonthIndex() {
            const today = new Date();
            const currentMonth = today.getMonth() + 1;
            const currentYear = today.getFullYear();
            const searchMonth = String(currentMonth).padStart(2, '0') + '/' + currentYear;
            
            for (let i = 0; i < allData.length; i++) {
                if (allData[i].month === searchMonth) {
                    return i;
                }
            }
            return 0;
        }
        
        function initData() {
            const saved = localStorage.getItem('financialDataDynamic');
            const savedYield = localStorage.getItem('monthlyEstYield');
            const savedInflation = localStorage.getItem('inflationRate');
            
            if (savedYield) {
                monthlyEstYield = parseFloat(savedYield);
                document.getElementById('monthlyEstYield').value = monthlyEstYield;
                updateEstYieldDisplay();
            }
            
            if (savedInflation) {
                inflationRate = parseFloat(savedInflation);
                document.getElementById('inflationRate').value = inflationRate;
            }
            
            if (saved) {
                try {
                    allData = JSON.parse(saved);
                    if (allData.length === 0) throw 'Empty data';
                } catch(e) {
                    createDefaultData();
                }
            } else {
                createDefaultData();
            }
            calculateAll();
            currentMonthIndex = findCurrentMonthIndex();
            updateTotalMonthsDisplay();
        }
        
        function createDefaultData() {
            const today = new Date();
            const startYear = today.getFullYear();
            const startMonth = today.getMonth() + 1;
            const months = generateMonths(startYear, startMonth, 300);
            allData = months.map(month => ({
                month: month,
                salary: 3000, misc: 100,
                rent: 800, food: 300, fixCosts: 150, others: 200, loan: 300,
                investment: 500,
                monthlyGain: 0,
                cumulatedGains: 0, 
                peeLoreal: 0
            }));
        }
        
        function updateEstYield() {
            monthlyEstYield = parseFloat(document.getElementById('monthlyEstYield').value) || 0;
            updateEstYieldDisplay();
            localStorage.setItem('monthlyEstYield', monthlyEstYield);
            recalculateGains();
        }
        
        function updateEstYieldDisplay() {
            const monthlyRate = (monthlyEstYield / 12).toFixed(2);
            document.getElementById('monthlyEstYieldDisplay').textContent = monthlyRate;
        }
        
        function updateInflationRate() {
            inflationRate = parseFloat(document.getElementById('inflationRate').value) || 2.5;
            localStorage.setItem('inflationRate', inflationRate);
            if (showInflation) updateAllCharts();
        }
        
        function toggleInflationCharts() {
            showInflation = !showInflation;
            const btn = document.getElementById('btnToggleInflation');
            const status = document.getElementById('inflationStatus');
            
            if (showInflation) {
                btn.textContent = 'Hide Inflation-Adjusted Charts';
                btn.style.background = 'linear-gradient(135deg, #6C3483 0%, #9D5CE6 100%)';
                status.textContent = 'ON';
                status.style.color = '#4A74F3';
            } else {
                btn.textContent = 'Show Inflation-Adjusted Charts';
                btn.style.background = 'linear-gradient(135deg, #4A74F3 0%, #6C8BE0 100%)';
                status.textContent = 'OFF';
                status.style.color = '#9D5CE6';
            }
            
            updateAllCharts();
        }
        
        function adjustForInflation(value, monthIndex) {
            const monthlyInflation = Math.pow(1 + inflationRate / 100, 1/12) - 1;
            return value / Math.pow(1 + monthlyInflation, monthIndex);
        }
        
        function recalculateGains() {
            const monthlyYieldRate = monthlyEstYield / 12 / 100;
            let cumulatedGains = 0;
            
            allData.forEach((row, index) => {
                const monthlyInvestment = row.investment || 0;
                let monthlyGain = 0;
                
                if (index === 0) {
                    monthlyGain = monthlyYieldRate * monthlyInvestment / 2;
                } else {
                    const previousRow = allData[index - 1];
                    const previousCapital = (previousRow.cumulatedInvestment || 0) + (previousRow.cumulatedGains || 0);
                    monthlyGain = monthlyYieldRate * (previousCapital + monthlyInvestment / 2);
                }
                
                row.monthlyGain = monthlyGain;
                cumulatedGains += monthlyGain;
                row.cumulatedGains = cumulatedGains;
            });
            
            calculateAll();
            renderTable();
            autoSave();
            updateAllCharts();
        }
        
        function calculateAll() {
            let cumulatedSavings = 0;
            let cumulatedInvestment = 0;
            
            allData.forEach(row => {
                row.totalIncome = (row.salary || 0) + (row.misc || 0);
                row.totalExpenses = (row.rent || 0) + (row.food || 0) + (row.fixCosts || 0) + (row.others || 0) + (row.loan || 0);
                row.savings = row.totalIncome - row.totalExpenses;
                cumulatedSavings += row.savings;
                row.cumulatedSavings = cumulatedSavings;
                cumulatedInvestment += (row.investment || 0);
                row.cumulatedInvestment = cumulatedInvestment;
                row.totalPortfolio = cumulatedInvestment + (row.cumulatedGains || 0) + (row.peeLoreal || 0);
                row.roi = cumulatedInvestment > 0 ? ((row.cumulatedGains || 0) / cumulatedInvestment * 100) : 0;
            });
        }
        
        function addMonthsBefore(count) {
            if (allData.length === 0) return;
            const firstMonth = allData[0].month;
            const [m, y] = firstMonth.split('/').map(Number);
            let year = y;
            let month = m - count;
            while (month <= 0) { month += 12; year--; }
            const newMonths = generateMonths(year, month, count);
            const newRows = newMonths.map(month => ({
                month: month,
                salary: 3000, misc: 100,
                rent: 800, food: 300, fixCosts: 150, others: 200, loan: 300,
                investment: 500,
                monthlyGain: 0,
                cumulatedGains: 0, 
                peeLoreal: 0
            }));
            allData = newRows.concat(allData);
            recalculateGains();
            currentMonthIndex = findCurrentMonthIndex();
            updateTotalMonthsDisplay();
            updateAllCharts();
        }
        
        function addMonthsAfter(count) {
            if (allData.length === 0) return;
            const lastMonth = allData[allData.length - 1].month;
            const [m, y] = lastMonth.split('/').map(Number);
            let year = y;
            let month = m + 1;
            if (month > 12) { month = 1; year++; }
            const newMonths = generateMonths(year, month, count);
            const newRows = newMonths.map(month => ({
                month: month,
                salary: 3000, misc: 100,
                rent: 800, food: 300, fixCosts: 150, others: 200, loan: 300,
                investment: 500,
                monthlyGain: 0,
                cumulatedGains: 0, 
                peeLoreal: 0
            }));
            allData = allData.concat(newRows);
            recalculateGains();
            updateTotalMonthsDisplay();
            updateAllCharts();
        }
        
        function deleteRow(index) {
            if (allData.length <= 12) {
                alert('Cannot delete! Minimum 12 months required.');
                return;
            }
            if (confirm('Delete month ' + allData[index].month + '?')) {
                allData.splice(index, 1);
                recalculateGains();
                currentMonthIndex = findCurrentMonthIndex();
                updateTotalMonthsDisplay();
                updateAllCharts();
            }
        }
        
        function updateTotalMonthsDisplay() {
            document.getElementById('totalMonthsDisplay').textContent = allData.length;
        }
        
        function saveData() {
            calculateAll();
            localStorage.setItem('financialDataDynamic', JSON.stringify(allData));
            localStorage.setItem('monthlyEstYield', monthlyEstYield);
            localStorage.setItem('inflationRate', inflationRate);
            alert('Data saved successfully!');
        }
        
        function autoSave() {
            calculateAll();
            localStorage.setItem('financialDataDynamic', JSON.stringify(allData));
            localStorage.setItem('monthlyEstYield', monthlyEstYield);
            localStorage.setItem('inflationRate', inflationRate);
        }
        
        function renderTable() {
            const tbody = document.getElementById('dataTableBody');
            tbody.innerHTML = '';
            
            allData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.month}</td>
                    <td><input type='number' step='0.01' value='${row.salary}' onchange='updateValue(${index}, "salary", this.value)'></td>
                    <td><input type='number' step='0.01' value='${row.misc}' onchange='updateValue(${index}, "misc", this.value)'></td>
                    <td class='calculated'>${row.totalIncome.toFixed(0)}</td>
                    <td><input type='number' step='0.01' value='${row.rent}' onchange='updateValue(${index}, "rent", this.value)'></td>
                    <td><input type='number' step='0.01' value='${row.food}' onchange='updateValue(${index}, "food", this.value)'></td>
                    <td><input type='number' step='0.01' value='${row.fixCosts}' onchange='updateValue(${index}, "fixCosts", this.value)'></td>
                    <td><input type='number' step='0.01' value='${row.others}' onchange='updateValue(${index}, "others", this.value)'></td>
                    <td><input type='number' step='0.01' value='${row.loan}' onchange='updateValue(${index}, "loan", this.value)'></td>
                    <td class='calculated'>${row.totalExpenses.toFixed(0)}</td>
                    <td class='calculated' style='color: ${row.savings >= 0 ? "#2649B2" : "#C39BD3"};'>${row.savings.toFixed(0)}</td>
                    <td><input type='number' step='0.01' value='${row.investment}' onchange='updateValue(${index}, "investment", this.value)'></td>
                    <td class='calculated' style='background: #D4D9F0;'>${row.monthlyGain.toFixed(2)}</td>
                    <td class='calculated'>${row.cumulatedGains.toFixed(0)}</td>
                    <td><input type='number' step='0.01' value='${row.peeLoreal}' onchange='updateValue(${index}, "peeLoreal", this.value)'></td>
                    <td class='calculated'>${row.cumulatedInvestment.toFixed(0)}</td>
                    <td class='calculated'>${row.totalPortfolio.toFixed(0)}</td>
                    <td class='calculated'>${row.roi.toFixed(2)}%</td>
                    <td><button class='btn-delete' onclick='deleteRow(${index})'>X</button></td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function updateValue(index, field, value) {
            allData[index][field] = parseFloat(value) || 0;
            
            if (field === 'investment') {
                recalculateGains();
            } else {
                calculateAll();
                renderTable();
                autoSave();
            }
        }
        
        function applyBulkEdit() {
            const category = document.getElementById('bulkCategory').value;
            const startMonth = document.getElementById('bulkStartMonth').value;
            const endMonth = document.getElementById('bulkEndMonth').value;
            const value = parseFloat(document.getElementById('bulkValue').value);
            
            if (!startMonth || !endMonth || isNaN(value)) {
                alert('Please fill all fields!'); return;
            }
            
            const fieldMap = {
                'Salary': 'salary', 'Misc.': 'misc', 'Rent': 'rent', 'Food': 'food',
                'Fix Costs': 'fixCosts', 'Others (Shopping; Restaurant…)': 'others',
                'Investment': 'investment', 'Loan (Studies; rental investment)': 'loan',
                "PEE L'OREAL": 'peeLoreal'
            };
            
            const field = fieldMap[category];
            const [startY, startM] = startMonth.split('-').map(Number);
            const [endY, endM] = endMonth.split('-').map(Number);
            
            let count = 0;
            allData.forEach(row => {
                const [m, y] = row.month.split('/').map(Number);
                const rowDate = y * 12 + m;
                const start = startY * 12 + startM;
                const end = endY * 12 + endM;
                
                if (rowDate >= start && rowDate <= end) {
                    row[field] = value;
                    count++;
                }
            });
            
            if (field === 'investment') {
                recalculateGains();
            } else {
                calculateAll();
                renderTable();
                autoSave();
            }
            
            alert('Applied ' + value + ' EUR to ' + count + ' months for ' + category);
        }
        
        function exportToJSON() {
            const exportData = {
                monthlyEstYield: monthlyEstYield,
                inflationRate: inflationRate,
                data: allData
            };
            const json = JSON.stringify(exportData, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'financial_data_' + new Date().toISOString().split('T')[0] + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function importFromJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (imported.data) {
                            allData = imported.data;
                            if (imported.monthlyEstYield) {
                                monthlyEstYield = imported.monthlyEstYield;
                                document.getElementById('monthlyEstYield').value = monthlyEstYield;
                                updateEstYieldDisplay();
                            }
                            if (imported.inflationRate) {
                                inflationRate = imported.inflationRate;
                                document.getElementById('inflationRate').value = inflationRate;
                            }
                        } else {
                            allData = imported;
                        }
                        calculateAll();
                        currentMonthIndex = findCurrentMonthIndex();
                        renderTable();
                        saveData();
                        updateTotalMonthsDisplay();
                        updateAllCharts();
                        alert('Data imported!');
                    } catch (err) {
                        alert('Error: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function resetToDefault() {
            if (confirm('Reset all data to default 300 months?')) {
                localStorage.removeItem('financialDataDynamic');
                localStorage.removeItem('monthlyEstYield');
                localStorage.removeItem('inflationRate');
                monthlyEstYield = 8;
                inflationRate = 2.5;
                document.getElementById('monthlyEstYield').value = 8;
                document.getElementById('inflationRate').value = 2.5;
                updateEstYieldDisplay();
                showInflation = false;
                initData();
                renderTable();
                updateAllCharts();
            }
        }
        
        function updateStats() {
            const currentRow = allData[currentMonthIndex];
            const monthName = currentRow.month;
            
            const html = `
                <div class='stat-card'><h3>Monthly Income (${monthName})</h3><div class='value'>${currentRow.totalIncome.toLocaleString()} EUR</div></div>
                <div class='stat-card'><h3>Monthly Expenses (${monthName})</h3><div class='value'>${currentRow.totalExpenses.toLocaleString()} EUR</div></div>
                <div class='stat-card positive'><h3>Total Savings (${monthName})</h3><div class='value'>${currentRow.cumulatedSavings.toLocaleString()} EUR</div></div>
                <div class='stat-card positive'><h3>Total Portfolio (${monthName})</h3><div class='value'>${currentRow.totalPortfolio.toLocaleString()} EUR</div></div>
                <div class='stat-card ${currentRow.roi > 0 ? 'positive' : 'negative'}'><h3>ROI (${monthName})</h3><div class='value'>${currentRow.roi.toFixed(1)}%</div></div>
            `;
            document.getElementById('statsContainer').innerHTML = html;
        }
        
        function initMonthFilters() {
            const incomeFilter = document.getElementById('incomeMonthFilter');
            const expenseFilter = document.getElementById('expenseMonthFilter');
            const budgetFilter = document.getElementById('budgetMonthFilter');
            
            incomeFilter.innerHTML = '';
            expenseFilter.innerHTML = '';
            budgetFilter.innerHTML = '';
            
            allData.forEach((row, index) => {
                const opt1 = new Option(row.month, index);
                const opt2 = new Option(row.month, index);
                const opt3 = new Option(row.month, index);
                if (index === currentMonthIndex) {
                    opt1.selected = true;
                    opt2.selected = true;
                    opt3.selected = true;
                }
                incomeFilter.add(opt1);
                expenseFilter.add(opt2);
                budgetFilter.add(opt3);
            });
        }
        
        function createChart1() {
            const months = allData.map(d => d.month);
            const incomeValues = allData.map(d => d.totalIncome);
            const expenseValues = allData.map(d => d.totalExpenses);
            const savingsValues = allData.map(d => d.savings);
            
            if (chart1Instance) chart1Instance.destroy();
            chart1Instance = Highcharts.chart('chart1', {
                chart: { type: 'line', backgroundColor: 'transparent', zoomType: 'x' },
                title: { text: null },
                xAxis: { categories: months, crosshair: true, labels: { rotation: -45, style: { fontSize: '10px' } } },
                yAxis: { title: { text: 'Amount (EUR)', style: { color: '#2649B2' } } },
                tooltip: { shared: true, valueDecimals: 0, valueSuffix: ' EUR' },
                series: [
                    { name: 'Income', data: incomeValues, color: '#4A74F3', lineWidth: 2 },
                    { name: 'Expenses', data: expenseValues, color: '#8E44AD', lineWidth: 2 },
                    { name: 'Monthly Savings', data: savingsValues, color: '#2649B2', type: 'area', fillColor: { linearGradient: [0, 0, 0, 300], stops: [[0, 'rgba(38,73,178,0.3)'], [1, 'rgba(38,73,178,0.05)']] }, lineWidth: 2 }
                ],
                plotOptions: { line: { marker: { enabled: false } }, area: { marker: { enabled: false } } },
                credits: { enabled: false }
            });
        }
        
        function updateChart2() {
            const monthIndex = parseInt(document.getElementById('incomeMonthFilter').value);
            const row = allData[monthIndex];
            
            Highcharts.chart('chart2', {
                chart: { type: 'pie', backgroundColor: 'transparent' },
                title: { text: row.month, style: { color: '#2649B2', fontWeight: 'bold' } },
                tooltip: { pointFormat: '<b>{point.name}</b>: {point.y:,.0f} EUR ({point.percentage:.1f}%)' },
                series: [{ name: 'Amount', data: [{ name: 'Salary', y: row.salary }, { name: 'Misc.', y: row.misc }], colorByPoint: true }],
                colors: ['#2649B2', '#4A74F3'],
                plotOptions: { pie: { innerSize: '50%', dataLabels: { format: '<b>{point.name}</b>: {point.y:,.0f} EUR', style: { color: '#2649B2' } }, borderWidth: 2, borderColor: '#E8DAEF' } },
                credits: { enabled: false }
            });
        }
        
        function updateChart3() {
            const monthIndex = parseInt(document.getElementById('expenseMonthFilter').value);
            const row = allData[monthIndex];
            
            Highcharts.chart('chart3', {
                chart: { type: 'pie', backgroundColor: 'transparent' },
                title: { text: row.month, style: { color: '#6C3483', fontWeight: 'bold' } },
                tooltip: { pointFormat: '<b>{point.name}</b>: {point.y:,.0f} EUR ({point.percentage:.1f}%)' },
                series: [{ name: 'Amount', data: [
                    { name: 'Rent', y: row.rent }, { name: 'Food', y: row.food },
                    { name: 'Fix Costs', y: row.fixCosts }, { name: 'Others', y: row.others },
                    { name: 'Loan', y: row.loan }
                ], colorByPoint: true }],
                colors: ['#5B2C6F', '#6C3483', '#8E44AD', '#9D5CE6', '#C39BD3'],
                plotOptions: { pie: { dataLabels: { format: '<b>{point.name}</b>: {point.y:,.0f} EUR', style: { color: '#5B2C6F' } }, borderWidth: 2, borderColor: '#E8DAEF' } },
                credits: { enabled: false }
            });
        }
        
        function createChart4() {
            const months = allData.map(d => d.month);
            const savingsData = allData.map(d => d.cumulatedSavings);
            const savingsDataReal = showInflation ? allData.map((d, i) => adjustForInflation(d.cumulatedSavings, i)) : [];
            
            const series = [
                { name: 'Nominal Savings', data: savingsData, color: '#2649B2', fillColor: { linearGradient: [0, 0, 0, 300], stops: [[0, 'rgba(38,73,178,0.5)'], [1, 'rgba(38,73,178,0.1)']] }, lineWidth: 2 }
            ];
            
            if (showInflation) {
                series.push({ name: 'Real Savings (Inflation-Adjusted)', data: savingsDataReal, color: '#9D5CE6', dashStyle: 'Dash', fillColor: { linearGradient: [0, 0, 0, 300], stops: [[0, 'rgba(157,92,230,0.3)'], [1, 'rgba(157,92,230,0.05)']] }, lineWidth: 2 });
            }
            
            if (chart4Instance) chart4Instance.destroy();
            chart4Instance = Highcharts.chart('chart4', {
                chart: { type: 'area', backgroundColor: 'transparent' },
                title: { text: showInflation ? 'Inflation Rate: ' + inflationRate + '% annual' : null, style: { color: '#9D5CE6', fontSize: '0.9em' } },
                xAxis: { categories: months, crosshair: true, labels: { rotation: -45, style: { fontSize: '10px' } } },
                yAxis: { title: { text: 'Cumulated Savings (EUR)', style: { color: '#2649B2' } } },
                tooltip: { shared: true, valueDecimals: 0, valueSuffix: ' EUR' },
                series: series,
                plotOptions: { area: { marker: { enabled: false } } },
                credits: { enabled: false }
            });
        }
        
        function createChart5() {
            const months = allData.map(d => d.month);
            const cumInv = allData.map(d => d.cumulatedInvestment);
            const gains = allData.map(d => d.cumulatedGains);
            const pee = allData.map(d => d.peeLoreal);
            const portfolio = allData.map(d => d.totalPortfolio);
            
            const portfolioReal = showInflation ? allData.map((d, i) => adjustForInflation(d.totalPortfolio, i)) : [];
            const cumInvReal = showInflation ? allData.map((d, i) => adjustForInflation(d.cumulatedInvestment, i)) : [];
            
            const series = [
                { name: 'Cumulated Investment', data: cumInv, color: '#6C8BE0', lineWidth: 2 },
                { name: 'Cumulated Gains', data: gains, color: '#8E7DE3', dashStyle: 'ShortDot', lineWidth: 2 },
                { name: "PEE L'Oreal", data: pee, color: '#9D5CE6', lineWidth: 2 },
                { name: 'Total Portfolio', data: portfolio, color: '#2649B2', lineWidth: 3 }
            ];
            
            if (showInflation) {
                series.push({ name: 'Portfolio (Real)', data: portfolioReal, color: '#B55CE6', dashStyle: 'Dash', lineWidth: 3 });
                series.push({ name: 'Investment (Real)', data: cumInvReal, color: '#D4D9F0', dashStyle: 'Dash', lineWidth: 2 });
            }
            
            if (chart5Instance) chart5Instance.destroy();
            chart5Instance = Highcharts.chart('chart5', {
                chart: { type: 'line', backgroundColor: 'transparent' },
                title: { text: showInflation ? 'Inflation Rate: ' + inflationRate + '% annual' : null, style: { color: '#9D5CE6', fontSize: '0.9em' } },
                xAxis: { categories: months, crosshair: true, labels: { rotation: -45, style: { fontSize: '10px' } } },
                yAxis: { title: { text: 'Value (EUR)', style: { color: '#2649B2' } } },
                tooltip: { shared: true, valueDecimals: 0, valueSuffix: ' EUR' },
                series: series,
                plotOptions: { line: { marker: { enabled: false } } },
                credits: { enabled: false }
            });
        }
        
        function createChart6() {
            const months = allData.map(d => d.month);
            const roi = allData.map(d => d.roi);
            
            if (chart6Instance) chart6Instance.destroy();
            chart6Instance = Highcharts.chart('chart6', {
                chart: { type: 'area', backgroundColor: 'transparent' },
                title: { text: null },
                xAxis: { categories: months, crosshair: true, labels: { rotation: -45, style: { fontSize: '10px' } } },
                yAxis: { title: { text: 'ROI (%)', style: { color: '#2649B2' } }, plotLines: [{ value: 0, color: '#8E44AD', width: 2, dashStyle: 'Dash' }] },
                tooltip: { valueDecimals: 2, valueSuffix: '%' },
                series: [{ name: 'ROI', data: roi, color: '#4A74F3', fillColor: { linearGradient: [0, 0, 0, 300], stops: [[0, 'rgba(74,116,243,0.4)'], [1, 'rgba(74,116,243,0.05)']] }, lineWidth: 2 }],
                plotOptions: { area: { marker: { enabled: false } } },
                credits: { enabled: false }
            });
        }
        
        function updateChart7() {
            const monthIndex = parseInt(document.getElementById('budgetMonthFilter').value);
            const row = allData[monthIndex];
            
            const needsAmount = row.rent + row.food + row.fixCosts + row.loan;
            const wantsAmount = row.others;
            const savingsAmount = row.investment + row.savings;
            const total = row.totalIncome;
            
            const needsPercent = total > 0 ? (needsAmount / total * 100) : 0;
            const wantsPercent = total > 0 ? (wantsAmount / total * 100) : 0;
            const savingsPercent = total > 0 ? (savingsAmount / total * 100) : 0;
            
            Highcharts.chart('chart7', {
                chart: { type: 'pie', backgroundColor: 'transparent' },
                title: { text: row.month + ' - Total: ' + total.toLocaleString() + ' EUR', style: { color: '#2649B2', fontWeight: 'bold' } },
                tooltip: { useHTML: true, pointFormat: '<b>{point.name}</b><br/>Amount: <b>{point.amount:,.0f} EUR</b><br/>Percentage: <b>{point.percentage:.1f}%</b>' },
                plotOptions: { pie: { innerSize: '60%', dataLabels: { enabled: true, format: '<b>{point.name}</b><br/>{point.percentage:.1f}%<br/>{point.amount:,.0f} EUR', style: { color: '#2649B2' } }, borderWidth: 2, borderColor: '#E8DAEF' } },
                series: [{ name: 'Budget', data: [
                    { name: 'Needs', y: needsPercent, amount: needsAmount, color: '#6C3483' },
                    { name: 'Wants', y: wantsPercent, amount: wantsAmount, color: '#9D5CE6' },
                    { name: 'Savings', y: savingsPercent, amount: savingsAmount, color: '#2649B2' }
                ] }],
                credits: { enabled: false }
            });
        }
        
        function updateAllCharts() {
            updateStats();
            initMonthFilters();
            createChart1();
            updateChart2();
            updateChart3();
            createChart4();
            createChart5();
            createChart6();
            updateChart7();
        }
        
        window.onload = function() {
            initData();
            renderTable();
            updateAllCharts();
        };
    </script>
</body>
</html>
